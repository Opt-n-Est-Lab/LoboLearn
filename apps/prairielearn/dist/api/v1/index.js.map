{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/api/v1/index.ts"],"names":[],"mappings":"AAAA,OAAO,EAAkD,MAAM,EAAE,MAAM,SAAS,CAAC;AACjF,OAAO,YAAY,MAAM,uBAAuB,CAAC;AAEjD,OAAO,KAAK,KAAK,MAAM,qBAAqB,CAAC;AAC7C,OAAO,KAAK,MAAM,MAAM,sBAAsB,CAAC;AAE/C,MAAM,MAAM,GAAG,MAAM,EAAE,CAAC;AAExB;;;;GAIG;AACH,MAAM,0BAA0B,GAAG,YAAY,CAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;IACvE,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,CAAC,mCAAmC,EAAE,CAAC;QAC/D,MAAM,IAAI,KAAK,CAAC,eAAe,CAAC,GAAG,EAAE,mCAAmC,CAAC,CAAC;IAC5E,CAAC;IACD,IAAI,EAAE,CAAC;AACT,CAAC,CAAC,CAAC;AAEH;;;GAGG;AACH,SAAS,sBAAsB,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB;IAC7E,IAAI,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,cAAc,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC;QACrE,MAAM,IAAI,KAAK,CAAC,eAAe,CAAC,GAAG,EAAE,eAAe,CAAC,CAAC;IACxD,CAAC;IACD,IAAI,EAAE,CAAC;AACT,CAAC;AAED,mCAAmC;AACnC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,MAAM,CAAC,sBAAsB,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;AAE3D,kDAAkD;AAClD,MAAM,CAAC,GAAG,CAAC,6CAA6C,EAAE;IACxD,CAAC,MAAM,MAAM,CAAC,4CAA4C,CAAC,CAAC,CAAC,OAAO;IACpE,sBAAsB;IACtB,uEAAuE;IACvE,uEAAuE;IACvE,sBAAsB;IACtB,CAAC,MAAM,MAAM,CAAC,6CAA6C,CAAC,CAAC,CAAC,OAAO;IACrE,6EAA6E;IAC7E,2EAA2E;IAC3E,4EAA4E;IAC5E,uCAAuC;IACvC,CAAC,MAAM,MAAM,CAAC,0DAA0D,CAAC,CAAC,CAAC,OAAO;IAClF,CAAC,MAAM,MAAM,CAAC,yCAAyC,CAAC,CAAC,CAAC,OAAO;CAClE,CAAC,CAAC;AAEH,SAAS;AACT,MAAM,CAAC,GAAG,CACR,yDAAyD,EACzD,CAAC,MAAM,MAAM,CAAC,gDAAgD,CAAC,CAAC,CAAC,OAAO,CACzE,CAAC;AACF,MAAM,CAAC,GAAG,CACR,kEAAkE,EAClE,0BAA0B,EAC1B,CAAC,MAAM,MAAM,CAAC,wDAAwD,CAAC,CAAC,CAAC,OAAO,CACjF,CAAC;AACF,MAAM,CAAC,GAAG,CACR,yDAAyD,EACzD,0BAA0B,EAC1B,CAAC,MAAM,MAAM,CAAC,gDAAgD,CAAC,CAAC,CAAC,OAAO,CACzE,CAAC;AACF,MAAM,CAAC,GAAG,CACR,uDAAuD,EACvD,0BAA0B,EAC1B,CAAC,MAAM,MAAM,CAAC,8CAA8C,CAAC,CAAC,CAAC,OAAO,CACvE,CAAC;AACF,MAAM,CAAC,GAAG,CACR,0EAA0E,EAC1E,CAAC,MAAM,MAAM,CAAC,gDAAgD,CAAC,CAAC,CAAC,OAAO,CACzE,CAAC;AAEF,+CAA+C;AAC/C,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,MAAM,CAAC,eAAe,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;AAEpD,qDAAqD;AACrD,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC,CAAC;AAEzC,iEAAiE;AACjE,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;AAEjD,eAAe,MAAM,CAAC","sourcesContent":["import { type NextFunction, type Request, type Response, Router } from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport * as error from '@prairielearn/error';\nimport * as Sentry from '@prairielearn/sentry';\n\nconst router = Router();\n\n/**\n * Used to prevent access to student data if the user doesn't have student data\n * viewing permissions. This should be added to any routes that provide student\n * data.\n */\nconst authzHasCourseInstanceView = asyncHandler(async (req, res, next) => {\n  if (!res.locals.authz_data.has_course_instance_permission_view) {\n    throw new error.HttpStatusError(403, 'Requires student data view access');\n  }\n  next();\n});\n\n/**\n * We'll forbid API access to the example course unless the user is a global\n * administrator.\n */\nfunction assertNotExampleCourse(req: Request, res: Response, next: NextFunction) {\n  if (res.locals.course.example_course && !res.locals.is_administrator) {\n    throw new error.HttpStatusError(403, 'Access denied');\n  }\n  next();\n}\n\n// Pretty-print all JSON responses.\nrouter.use((await import('./prettyPrintJson.js')).default);\n\n// All course instance pages require authorization\nrouter.use('/course_instances/:course_instance_id(\\\\d+)', [\n  (await import('../../middlewares/authzCourseOrInstance.js')).default,\n  assertNotExampleCourse,\n  // A student who is course staff in another course could use the API to\n  // infiltrate data into a secure exam. We'll forbid API access entirely\n  // while in exam mode.\n  (await import('../../middlewares/forbidAccessInExamMode.js')).default,\n  // Asserts that the user has either course preview or course instance student\n  // data access. If a route provides access to student data, you should also\n  // include the `authzHasCourseInstanceView` middleware to ensure that access\n  // to student data is properly limited.\n  (await import('../../middlewares/authzHasCoursePreviewOrInstanceView.js')).default,\n  (await import('./endpoints/courseInstanceInfo/index.js')).default,\n]);\n\n// ROUTES\nrouter.use(\n  '/course_instances/:course_instance_id(\\\\d+)/assessments',\n  (await import('./endpoints/courseInstanceAssessments/index.js')).default,\n);\nrouter.use(\n  '/course_instances/:course_instance_id(\\\\d+)/assessment_instances',\n  authzHasCourseInstanceView,\n  (await import('./endpoints/courseInstanceAssessmentInstances/index.js')).default,\n);\nrouter.use(\n  '/course_instances/:course_instance_id(\\\\d+)/submissions',\n  authzHasCourseInstanceView,\n  (await import('./endpoints/courseInstanceSubmissions/index.js')).default,\n);\nrouter.use(\n  '/course_instances/:course_instance_id(\\\\d+)/gradebook',\n  authzHasCourseInstanceView,\n  (await import('./endpoints/courseInstanceGradebook/index.js')).default,\n);\nrouter.use(\n  '/course_instances/:course_instance_id(\\\\d+)/course_instance_access_rules',\n  (await import('./endpoints/courseInstanceAccessRules/index.js')).default,\n);\n\n// If no earlier routes matched, 404 the route.\nrouter.use((await import('./notFound.js')).default);\n\n// The Sentry error handler must come before our own.\nrouter.use(Sentry.expressErrorHandler());\n\n// Handle errors independently from the normal PL error handling.\nrouter.use((await import('./error.js')).default);\n\nexport default router;\n"]}