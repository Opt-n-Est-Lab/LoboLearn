{"version":3,"file":"20250226004222_course_instance_usages__submissions__backfill_v2.js","sourceRoot":"","sources":["../../src/batched-migrations/20250226004222_course_instance_usages__submissions__backfill_v2.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,CAAC,EAAE,MAAM,KAAK,CAAC;AAExB,OAAO,EAAE,oBAAoB,EAAE,MAAM,0BAA0B,CAAC;AAChE,OAAO,EAAE,YAAY,EAAE,UAAU,EAAE,QAAQ,EAAE,MAAM,wBAAwB,CAAC;AAE5E,MAAM,GAAG,GAAG,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAE1C,MAAM,WAAW,GAAG,sBAAsB,CAAC;AAE3C,eAAe,oBAAoB,CAAC;IAClC,KAAK,CAAC,aAAa;QACjB,uDAAuD;QACvD,MAAM,UAAU,CAAC,GAAG,CAAC,iBAAiB,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;QAEzD,qEAAqE;QACrE,MAAM,GAAG,GAAG,MAAM,QAAQ,CACxB,GAAG,CAAC,aAAa,EACjB,EAAE,WAAW,EAAE,EACf,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC,QAAQ,EAAE,CACtC,CAAC;QACF,OAAO,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,SAAS,EAAE,OAAO,EAAE,CAAC;IAC9C,CAAC;IACD,KAAK,CAAC,OAAO,CAAC,KAAa,EAAE,GAAW;QACtC,MAAM,UAAU,CAAC,GAAG,CAAC,6CAA6C,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC,CAAC;IACtF,CAAC;CACF,CAAC,CAAC","sourcesContent":["import { z } from 'zod';\n\nimport { makeBatchedMigration } from '@prairielearn/migrations';\nimport { loadSqlEquiv, queryAsync, queryRow } from '@prairielearn/postgres';\n\nconst sql = loadSqlEquiv(import.meta.url);\n\nconst CUTOFF_DATE = '2025-02-15T00:00:00Z';\n\nexport default makeBatchedMigration({\n  async getParameters() {\n    // First delete usage data older than a hard-coded date\n    await queryAsync(sql.delete_old_usages, { CUTOFF_DATE });\n\n    // Only backfill from submissions that are older than the cutoff date\n    const max = await queryRow(\n      sql.select_bounds,\n      { CUTOFF_DATE },\n      z.bigint({ coerce: true }).nullable(),\n    );\n    return { min: 1n, max, batchSize: 100_000 };\n  },\n  async execute(start: bigint, end: bigint): Promise<void> {\n    await queryAsync(sql.update_course_instance_usages_for_submissions, { start, end });\n  },\n});\n"]}