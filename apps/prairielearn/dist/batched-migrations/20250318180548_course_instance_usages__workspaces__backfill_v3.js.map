{"version":3,"file":"20250318180548_course_instance_usages__workspaces__backfill_v3.js","sourceRoot":"","sources":["../../src/batched-migrations/20250318180548_course_instance_usages__workspaces__backfill_v3.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,CAAC,EAAE,MAAM,KAAK,CAAC;AAExB,OAAO,EAAE,oBAAoB,EAAE,MAAM,0BAA0B,CAAC;AAChE,OAAO,EAAE,YAAY,EAAE,UAAU,EAAE,QAAQ,EAAE,MAAM,wBAAwB,CAAC;AAE5E,MAAM,GAAG,GAAG,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAE1C,MAAM,QAAQ,GAAG,sBAAsB,CAAC;AAExC,eAAe,oBAAoB,CAAC;IAClC,KAAK,CAAC,aAAa;QACjB,8BAA8B;QAC9B,MAAM,UAAU,CAAC,GAAG,CAAC,iBAAiB,EAAE,EAAE,QAAQ,EAAE,CAAC,CAAC;QAEtD,sDAAsD;QACtD,MAAM,GAAG,GAAG,EAAE,CAAC;QACf,MAAM,GAAG,GAAG,MAAM,QAAQ,CACxB,GAAG,CAAC,gBAAgB,EACpB,EAAE,QAAQ,EAAE,EACZ,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC,QAAQ,EAAE,CACtC,CAAC;QACF,OAAO,EAAE,GAAG,EAAE,GAAG,EAAE,SAAS,EAAE,MAAM,EAAE,CAAC;IACzC,CAAC;IACD,KAAK,CAAC,OAAO,CAAC,KAAa,EAAE,GAAW;QACtC,MAAM,UAAU,CAAC,GAAG,CAAC,4CAA4C,EAAE;YACjE,KAAK;YACL,GAAG;YACH,QAAQ;SACT,CAAC,CAAC;IACL,CAAC;CACF,CAAC,CAAC","sourcesContent":["import { z } from 'zod';\n\nimport { makeBatchedMigration } from '@prairielearn/migrations';\nimport { loadSqlEquiv, queryAsync, queryRow } from '@prairielearn/postgres';\n\nconst sql = loadSqlEquiv(import.meta.url);\n\nconst END_DATE = '2025-03-21T00:00:00Z';\n\nexport default makeBatchedMigration({\n  async getParameters() {\n    // First delete old usage data\n    await queryAsync(sql.delete_old_usages, { END_DATE });\n\n    // Only backfill from workspaces within the date range\n    const min = 1n;\n    const max = await queryRow(\n      sql.select_max_bound,\n      { END_DATE },\n      z.bigint({ coerce: true }).nullable(),\n    );\n    return { min, max, batchSize: 10_000 };\n  },\n  async execute(start: bigint, end: bigint): Promise<void> {\n    await queryAsync(sql.update_course_instance_usages_for_workspaces, {\n      start,\n      end,\n      END_DATE,\n    });\n  },\n});\n"]}