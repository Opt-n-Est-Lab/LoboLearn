{"version":3,"file":"CourseRequestsTable.html.js","sourceRoot":"","sources":["../../src/components/CourseRequestsTable.html.ts"],"names":[],"mappings":"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","sourcesContent":["import { escapeHtml, html } from '@prairielearn/html';\n\nimport { type CourseRequestRow } from '../lib/course-request.js';\nimport { type Institution } from '../lib/db-types.js';\n\nimport { JobStatus } from './JobStatus.html.js';\n\nexport function CourseRequestsTable({\n  rows,\n  institutions,\n  coursesRoot,\n  showAll,\n  csrfToken,\n  urlPrefix,\n}: {\n  rows: CourseRequestRow[];\n  institutions: Institution[];\n  coursesRoot: string;\n  showAll: boolean;\n  csrfToken: string;\n  urlPrefix: string;\n}) {\n  const headerPrefix = showAll ? 'All' : 'Pending';\n  return html`\n    <div class=\"card mb-4\">\n      <div class=\"card-header bg-primary text-white d-flex align-items-center\">\n        <h2>${headerPrefix} course requests</h2>\n        ${showAll\n          ? ''\n          : html`\n              <a\n                class=\"btn btn-sm btn-light ms-auto\"\n                href=\"${urlPrefix}/administrator/courseRequests\"\n              >\n                <i class=\"fa fa-search\" aria-hidden=\"true\"></i>\n                <span class=\"d-none d-sm-inline\">View All</span>\n              </a>\n            `}\n      </div>\n      <div class=\"table-responsive\">\n        <table class=\"table table-sm\" aria-label=\"Course requests\">\n          <thead>\n            <tr>\n              <th>Created At</th>\n              <th>Short Name / Title</th>\n              <th>Institution</th>\n              <th>Requested By</th>\n              <th>PrairieLearn User</th>\n              <th>GitHub Username</th>\n              <th>Referral Source</th>\n              <th>Status</th>\n              ${showAll ? html`<th>Updated By</th>` : ''}\n              <th>Actions</th>\n              <th>Details</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${rows.map((row) => {\n              return html`\n                <tr>\n                  <td class=\"align-middle\">${row.created_at.toISOString()}</td>\n                  <td class=\"align-middle\">${row.short_name}: ${row.title}</td>\n                  <td class=\"align-middle\">${row.institution}</td>\n                  <td class=\"align-middle\">\n                    ${row.first_name} ${row.last_name} (${row.work_email})\n                  </td>\n                  <td class=\"align-middle\">${row.user_name} (${row.user_uid})</td>\n                  <td class=\"align-middle\">${row.github_user}</td>\n                  <td class=\"align-middle\">${row.referral_source}</td>\n                  <td class=\"align-middle\">\n                    ${CourseRequestStatusIcon({ status: row.approved_status })}\n                  </td>\n                  ${showAll\n                    ? html`\n                        <td class=\"align-middle\">\n                          ${row.approved_status !== 'pending'\n                            ? (row.approved_by_name ?? 'Automatically Approved')\n                            : ''}\n                        </td>\n                      `\n                    : ''}\n                  <td class=\"align-middle\">\n                    ${row.approved_status !== 'approved'\n                      ? html`\n                          <button\n                            type=\"button\"\n                            class=\"btn btn-sm btn-danger text-nowrap me-2\"\n                            data-bs-toggle=\"popover\"\n                            data-bs-container=\"body\"\n                            data-bs-html=\"true\"\n                            data-bs-placement=\"auto\"\n                            data-bs-title=\"Deny course request\"\n                            data-bs-content=\"${escapeHtml(\n                              CourseRequestDenyForm({\n                                request: row,\n                                csrfToken,\n                              }),\n                            )}\"\n                          >\n                            <i class=\"fa fa-times\" aria-hidden=\"true\"></i> Deny\n                          </button>\n                          <button\n                            type=\"button\"\n                            class=\"btn btn-sm btn-success text-nowrap\"\n                            data-bs-toggle=\"popover\"\n                            data-bs-container=\"body\"\n                            data-bs-html=\"true\"\n                            data-bs-placement=\"auto\"\n                            data-bs-title=\"Approve course request\"\n                            data-bs-content=\"${escapeHtml(\n                              CourseRequestApproveForm({\n                                request: row,\n                                institutions,\n                                coursesRoot,\n                                csrfToken,\n                              }),\n                            )}\"\n                          >\n                            <i class=\"fa fa-check\" aria-hidden=\"true\"></i> Approve\n                          </button>\n                        `\n                      : ''}\n                  </td>\n                  <td class=\"align-middle\">\n                    ${row.jobs.length > 0\n                      ? html`\n                          <button\n                            class=\"btn btn-secondary btn-xs text-nowrap show-hide-btn collapsed\"\n                            data-bs-toggle=\"collapse\"\n                            data-bs-target=\"#course-requests-job-list-${row.id}\"\n                            aria-expanded=\"false\"\n                            aria-controls=\"course-requests-job-list-${row.id}\"\n                          >\n                            <i class=\"fa fa-angle-up fa-fw expand-icon\"></i>\n                            Show Jobs\n                          </button>\n                        `\n                      : ''}\n                  </td>\n                </tr>\n                ${row.jobs.length > 0\n                  ? html`\n                      <tr>\n                        <td colspan=\"${showAll ? 11 : 10}\" class=\"p-0\">\n                          <div id=\"course-requests-job-list-${row.id}\" class=\"collapse\">\n                            <table\n                              class=\"table table-sm table-active mb-0\"\n                              aria-label=\"Course request jobs\"\n                            >\n                              <thead>\n                                <th>Number</th>\n                                <th>Start Date</th>\n                                <th>End Date</th>\n                                <th>User</th>\n                                <th>Status</th>\n                                <th></th>\n                              </thead>\n                              ${row.jobs\n                                .slice()\n                                .reverse()\n                                .map((job) => {\n                                  return html`\n                                    <tr>\n                                      <td>${job.number}</td>\n                                      <td>${job.start_date.toISOString()}</td>\n                                      <td>${job.finish_date?.toISOString()}</td>\n                                      <td>${job.authn_user_name}</td>\n                                      <td>${JobStatus({ status: job.status })}</td>\n                                      <td>\n                                        <a\n                                          href=\"${urlPrefix}/administrator/jobSequence/${job.id}\"\n                                          class=\"btn btn-xs btn-info float-end\"\n                                        >\n                                          Details\n                                        </a>\n                                      </td>\n                                    </tr>\n                                  `;\n                                })}\n                            </table>\n                          </div>\n                        </td>\n                      </tr>\n                    `\n                  : ''}\n              `;\n            })}\n          </tbody>\n        </table>\n      </div>\n      <div class=\"card-footer\">\n        <small>\n          Accepting a course request will automatically create a new GitHub repository and add the\n          course to the database.\n        </small>\n      </div>\n    </div>\n  `;\n}\n\nfunction CourseRequestApproveForm({\n  request,\n  institutions,\n  coursesRoot,\n  csrfToken,\n}: {\n  request: CourseRequestRow;\n  institutions: Institution[];\n  coursesRoot: string;\n  csrfToken: string;\n}) {\n  const repo_name = 'pl-' + request.short_name.replaceAll(' ', '').toLowerCase();\n  return html`\n    <form name=\"create-course-from-request-form-${request.id}\" method=\"POST\">\n      <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n      <input type=\"hidden\" name=\"__action\" value=\"create_course_from_request\" />\n      <input type=\"hidden\" name=\"request_id\" value=\"${request.id}\" />\n\n      <div class=\"mb-3\">\n        <label class=\"form-label\">Institution:</label>\n        <select\n          name=\"institution_id\"\n          class=\"form-select\"\n          onchange=\"this.closest('form').querySelector('[name=display_timezone]').value = this.querySelector('option:checked').dataset.timezone;\"\n        >\n          ${institutions.map((i) => {\n            return html`\n              <option value=\"${i.id}\" data-timezone=\"${i.display_timezone}\">${i.short_name}</option>\n            `;\n          })}\n        </select>\n      </div>\n      <div class=\"mb-3\">\n        <label class=\"form-label\" for=\"courseRequestAddInputShortName\">Short name:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputShortName\"\n          name=\"short_name\"\n          placeholder=\"XC 101\"\n          value=\"${request.short_name}\"\n        />\n      </div>\n      <div class=\"mb-3\">\n        <label class=\"form-label\" for=\"courseRequestAddInputTitle\">Title:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputTitle\"\n          name=\"title\"\n          placeholder=\"Template course title\"\n          value=\"${request.title}\"\n        />\n      </div>\n      <div class=\"mb-3\">\n        <label class=\"form-label\" for=\"courseRequestAddInputTimezone\">Timezone:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputTimezone\"\n          name=\"display_timezone\"\n          value=\"${institutions[0]?.display_timezone}\"\n        />\n      </div>\n      <div class=\"mb-3\">\n        <label class=\"form-label\" for=\"courseRequestAddInputPath\">Path:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputPath\"\n          name=\"path\"\n          value=\"${coursesRoot + '/' + repo_name}\"\n        />\n      </div>\n      <div class=\"mb-3\">\n        <label class=\"form-label\" for=\"courseRequestAddInputRepositoryName\">Repository Name:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputRepository\"\n          name=\"repository_short_name\"\n          value=\"${repo_name}\"\n        />\n      </div>\n      <div class=\"mb-3\">\n        <label for=\"courseRequestAddInputGithubUser\">GitHub Username:</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"courseRequestAddInputGithubUser\"\n          name=\"github_user\"\n          value=\"${request.github_user}\"\n        />\n      </div>\n\n      <div class=\"text-right\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"popover\">Cancel</button>\n        <button type=\"submit\" class=\"btn btn-primary\">Create course</button>\n      </div>\n    </form>\n  `;\n}\n\nfunction CourseRequestDenyForm({\n  request,\n  csrfToken,\n}: {\n  request: CourseRequestRow;\n  csrfToken: string;\n}) {\n  return html`\n    <form method=\"POST\">\n      <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n      <input type=\"hidden\" name=\"__action\" value=\"approve_deny_course_request\" />\n      <input type=\"hidden\" name=\"approve_deny_action\" value=\"deny\" />\n      <input type=\"hidden\" name=\"request_id\" value=\"${request.id}\" />\n      <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"popover\">Cancel</button>\n      <button type=\"submit\" class=\"btn btn-danger\">Deny</button>\n    </form>\n  `;\n}\n\nfunction CourseRequestStatusIcon({ status }: { status: CourseRequestRow['approved_status'] }) {\n  switch (status) {\n    case 'pending':\n      return html`<span class=\"badge text-bg-secondary\"><i class=\"fa fa-clock\"></i> Pending</span>`;\n    case 'creating':\n      return html`<span class=\"badge text-bg-info\"\n        ><i class=\"fa fa-sync\"></i> Job in progress</span\n      >`;\n    case 'failed':\n      return html`<span class=\"badge text-bg-danger\"><i class=\"fa fa-times\"></i> Job failed</span>`;\n    case 'approved':\n      return html`<span class=\"badge text-bg-success\"><i class=\"fa fa-check\"></i> Approved</span>`;\n    case 'denied':\n      return html`<span class=\"badge text-bg-danger\"><i class=\"fa fa-times\"></i> Denied</span>`;\n  }\n}\n"]}