{"version":3,"file":"PersonalNotesPanel.html.js","sourceRoot":"","sources":["../../src/components/PersonalNotesPanel.html.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,QAAQ,EAAE,MAAM,UAAU,CAAC;AAEpC,OAAO,EAAE,UAAU,EAAE,IAAI,EAAE,MAAM,oBAAoB,CAAC;AAEtD,OAAO,EAAE,MAAM,EAAE,MAAM,kBAAkB,CAAC;AAG1C,MAAM,UAAU,kBAAkB,CAAC,EACjC,QAAQ,EACR,gBAAgB,EAChB,mBAAmB,EACnB,YAAY,EACZ,SAAS,EACT,eAAe,GAAG,IAAI,EACtB,SAAS,EACT,OAAO,GAUR;IACC,OAAO,IAAI,CAAA;;;;;;QAML,QAAQ,CAAC,MAAM,KAAK,CAAC;QACrB,CAAC,CAAC,IAAI,CAAA,uDAAuD;QAC7D,CAAC,CAAC,IAAI,CAAA;;gBAEE,QAAQ,CAAC,GAAG,CACZ,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAA;;;;8BAIA,MAAM,CAAC,SAAS,oBAAoB,gBAAgB,wBAAwB,mBAAmB,CAAC,EAAE,SAAS,IAAI,CAAC,EAAE,IAAI,IAAI,CAAC,gBAAgB;;;wBAGjJ,IAAI,CAAC,gBAAgB;;sBAEvB,mBAAmB,CAAC,IAAI;YAC1B,YAAY,CAAC,MAAM;YACnB,YAAY,CAAC,eAAe;YAC5B,eAAe;YACf,IAAI,CAAC,IAAI,KAAK,gBAAgB;YAC5B,CAAC,CAAC,IAAI,CAAA;;8BAEE,wBAAwB,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;;yBAE7D;YACH,CAAC,CAAC,EAAE;;iBAET,CACF;;WAEJ;QACH,eAAe;QACf,CAAC,CAAC,IAAI,CAAA;;gBAEE,CAAC,mBAAmB,CAAC,IAAI,IAAI,CAAC,YAAY,CAAC,MAAM;YACjD,CAAC,CAAC,IAAI,CAAA;;;;mBAIH;YACH,CAAC,CAAC,CAAC,YAAY,CAAC,eAAe;gBAC7B,CAAC,CAAC,IAAI,CAAA;;8CAEsB,OAAO;;;qBAGhC;gBACH,CAAC,CAAC,IAAI,CAAA;wBACA,cAAc,CAAC,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;wBACxC,cAAc,CAAC,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;qBAC3C;;WAEV;QACH,CAAC,CAAC,EAAE;;GAET,CAAC;AACJ,CAAC;AAED,SAAS,cAAc,CAAC,EAAE,SAAS,EAAE,SAAS,EAA6C;IACzF,OAAO,IAAI,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;+BA2BkB,QAAQ,CAAC,MAAM,CAAC,kBAAkB,EAAE,EAAE,IAAI,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;;;;;cAK5E,SAAS,IAAI,IAAI;QACjB,CAAC,CAAC,IAAI,CAAA,mDAAmD,SAAS,MAAM;QACxE,CAAC,CAAC,EAAE;8DAC4C,SAAS;;;;;;;;;;;;;;;;;;GAkBpE,CAAC;AACJ,CAAC;AAED,SAAS,cAAc,CAAC,EAAE,SAAS,EAAE,SAAS,EAA6C;IACzF,OAAO,IAAI,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;YAkCD,SAAS,IAAI,IAAI;QACjB,CAAC,CAAC,IAAI,CAAA,mDAAmD,SAAS,MAAM;QACxE,CAAC,CAAC,EAAE;4DAC4C,SAAS;;;;;;;GAOlE,CAAC;AACJ,CAAC;AAED,SAAS,wBAAwB,CAAC,EAChC,IAAI,EACJ,SAAS,EACT,SAAS,GAKV;IACC,MAAM,cAAc,GAAG,IAAI,CAAA;;mDAEsB,IAAI,CAAC,gBAAgB;;wDAEhB,SAAS;QACzD,SAAS,IAAI,IAAI;QACjB,CAAC,CAAC,IAAI,CAAA,mDAAmD,SAAS,MAAM;QACxE,CAAC,CAAC,EAAE;mDACuC,IAAI,CAAC,EAAE;;;;;;GAMvD,CAAC;IAEF,OAAO,IAAI,CAAA;;;yCAG4B,IAAI,CAAC,gBAAgB;;;;;;yBAMrC,UAAU,CAAC,cAAc,CAAC;;;;;GAKhD,CAAC;AACJ,CAAC","sourcesContent":["import { filesize } from 'filesize';\n\nimport { escapeHtml, html } from '@prairielearn/html';\n\nimport { config } from '../lib/config.js';\nimport type { AssessmentInstance, File } from '../lib/db-types.js';\n\nexport function PersonalNotesPanel({\n  fileList,\n  courseInstanceId,\n  assessment_instance,\n  authz_result,\n  variantId,\n  allowNewUploads = true,\n  csrfToken,\n  context,\n}: {\n  fileList: File[];\n  courseInstanceId: string;\n  assessment_instance: Pick<AssessmentInstance, 'id' | 'open'>;\n  authz_result: Record<string, any>;\n  variantId?: string;\n  allowNewUploads?: boolean;\n  csrfToken: string;\n  context: 'question' | 'assessment';\n}) {\n  return html`\n    <div class=\"card mb-4\" id=\"attach-file-panel\">\n      <div class=\"card-header bg-secondary text-white d-flex align-items-center\">\n        <i class=\"fas fa-paperclip\"></i>\n        <h2>&nbsp;Personal Notes</h2>\n      </div>\n      ${fileList.length === 0\n        ? html`<div class=\"card-body\"><i>No attached notes</i></div>`\n        : html`\n            <ul class=\"list-group list-group-flush\">\n              ${fileList.map(\n                (file) => html`\n                  <li class=\"list-group-item d-flex align-items-center\">\n                    <a\n                      class=\"text-break me-2\"\n                      href=\"${config.urlPrefix}/course_instance/${courseInstanceId}/assessment_instance/${assessment_instance.id}/file/${file.id}/${file.display_filename}\"\n                      data-testid=\"attached-file\"\n                    >\n                      ${file.display_filename}\n                    </a>\n                    ${assessment_instance.open &&\n                    authz_result.active &&\n                    authz_result.authorized_edit &&\n                    allowNewUploads &&\n                    file.type === 'student_upload'\n                      ? html`\n                          <div class=\"ms-auto\">\n                            ${DeletePersonalNoteButton({ file, variantId, csrfToken })}\n                          </div>\n                        `\n                      : ''}\n                  </li>\n                `,\n              )}\n            </ul>\n          `}\n      ${allowNewUploads\n        ? html`\n            <div class=\"card-footer\">\n              ${!assessment_instance.open || !authz_result.active\n                ? html`\n                    <p class=\"small mb-0\">\n                      Notes can't be added or deleted because the assessment is closed.\n                    </p>\n                  `\n                : !authz_result.authorized_edit\n                  ? html`\n                      <div class=\"alert alert-warning mt-2\" role=\"alert\">\n                        You are viewing the ${context} instance of a different user and so are not\n                        authorized to add or delete personal notes.\n                      </div>\n                    `\n                  : html`\n                      ${AttachFileForm({ variantId, csrfToken })}\n                      ${UploadTextForm({ variantId, csrfToken })}\n                    `}\n            </div>\n          `\n        : ''}\n    </div>\n  `;\n}\n\nfunction AttachFileForm({ variantId, csrfToken }: { variantId?: string; csrfToken: string }) {\n  return html`\n    <div>\n      <button\n        class=\"btn btn-xs btn-secondary\"\n        type=\"button\"\n        data-bs-toggle=\"collapse\"\n        data-bs-target=\"#attachFileCollapse\"\n        aria-expanded=\"false\"\n        aria-controls=\"attachFileCollapse\"\n      >\n        Attach a file <i class=\"far fa-caret-square-down\"></i>\n      </button>\n      <div class=\"collapse\" id=\"attachFileCollapse\">\n        <form\n          class=\"attach-file-form mb-3\"\n          name=\"attach-file-form\"\n          method=\"POST\"\n          enctype=\"multipart/form-data\"\n        >\n          <p class=\"small mt-3\">\n            Attached files will be saved here for your reference. These files act as personal notes\n            and can be used for your own review purposes. They are not used for grading.\n          </p>\n          <div class=\"mb-3\">\n            <label class=\"form-label\" for=\"attachFileInput\">Choose file</label>\n            <input type=\"file\" name=\"file\" class=\"form-control\" id=\"attachFileInput\" />\n            <small class=\"form-text text-muted\">\n              Max file size: ${filesize(config.fileUploadMaxBytes, { base: 10, round: 0 })}\n            </small>\n          </div>\n          <div class=\"mb-3\">\n            <input type=\"hidden\" name=\"__action\" value=\"attach_file\" />\n            ${variantId != null\n              ? html`<input type=\"hidden\" name=\"__variant_id\" value=\"${variantId}\" />`\n              : ''}\n            <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n            <button type=\"submit\" class=\"btn btn-primary\" disabled>Attach file</button>\n          </div>\n        </form>\n\n        <script>\n          $(() => {\n            // Only enable the \"submit\" button if a file is selected.\n            const form = document.querySelector('form.attach-file-form');\n            const fileInput = form.querySelector('#attachFileInput');\n            const submitButton = form.querySelector('button[type=\"submit\"]');\n            fileInput.addEventListener('change', (e) => {\n              submitButton.disabled = fileInput.files.length === 0;\n            });\n          });\n        </script>\n      </div>\n    </div>\n  `;\n}\n\nfunction UploadTextForm({ variantId, csrfToken }: { variantId?: string; csrfToken: string }) {\n  return html`\n    <div>\n      <button\n        class=\"btn btn-xs btn-secondary\"\n        type=\"button\"\n        data-bs-toggle=\"collapse\"\n        data-bs-target=\"#attachTextCollapse\"\n        aria-expanded=\"false\"\n        aria-controls=\"attachTextCollapse\"\n      >\n        Add text note <i class=\"far fa-caret-square-down\"></i>\n      </button>\n      <div class=\"collapse\" id=\"attachTextCollapse\">\n        <form method=\"POST\" class=\"attach-text-form\">\n          <p class=\"small mt-3\">\n            Attached personal notes will be saved here for your reference. These notes can be used\n            for your own review purposes. They are not used for grading.\n          </p>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            aria-label=\"Text filename\"\n            name=\"filename\"\n            value=\"notes.txt\"\n          />\n          <div class=\"mb-3\">\n            <textarea\n              class=\"form-control\"\n              rows=\"5\"\n              aria-label=\"Text contents\"\n              name=\"contents\"\n              placeholder=\"Type or paste text here\"\n            ></textarea>\n          </div>\n          ${variantId != null\n            ? html`<input type=\"hidden\" name=\"__variant_id\" value=\"${variantId}\" />`\n            : ''}\n          <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n          <button type=\"submit\" class=\"btn btn-sm btn-primary\" name=\"__action\" value=\"attach_text\">\n            Add note\n          </button>\n        </form>\n      </div>\n    </div>\n  `;\n}\n\nfunction DeletePersonalNoteButton({\n  file,\n  variantId,\n  csrfToken,\n}: {\n  file: File;\n  variantId?: string;\n  csrfToken: string;\n}) {\n  const popoverContent = html`\n    <form name=\"attach-file-delete-form\" method=\"POST\">\n      <p>Are you sure you want to delete <strong>${file.display_filename}</strong>?</p>\n      <input type=\"hidden\" name=\"__action\" value=\"delete_file\" />\n      <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n      ${variantId != null\n        ? html`<input type=\"hidden\" name=\"__variant_id\" value=\"${variantId}\" />`\n        : ''}\n      <input type=\"hidden\" name=\"file_id\" value=\"${file.id}\" />\n      <div class=\"text-right\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"popover\">Cancel</button>\n        <button type=\"submit\" class=\"btn btn-primary\">Delete</button>\n      </div>\n    </form>\n  `;\n\n  return html`\n    <button\n      class=\"btn btn-xs btn-secondary\"\n      aria-label=\"Delete personal note ${file.display_filename}\"\n      data-bs-toggle=\"popover\"\n      data-bs-container=\"body\"\n      data-bs-html=\"true\"\n      data-bs-placement=\"auto\"\n      data-bs-title=\"Confirm delete\"\n      data-bs-content=\"${escapeHtml(popoverContent)}\"\n      data-testid=\"delete-personal-note-button\"\n    >\n      <i class=\"far fa-trash-alt\"></i>\n    </button>\n  `;\n}\n"]}