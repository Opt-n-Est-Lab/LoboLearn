{"version":3,"file":"documentation.js","sourceRoot":"","sources":["../../../../src/ee/lib/context-parsers/documentation.ts"],"names":[],"mappings":"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","sourcesContent":["import remarkGfm from 'remark-gfm';\nimport remarkParse from 'remark-parse';\nimport remarkStringify from 'remark-stringify';\nimport { unified } from 'unified';\n\nconst DEPRECATED_ELEMENTS = new Set(['pl-prairiedraw-figure', 'pl-threejs', 'pl-variable-score']);\nconst ALLOWED_ELEMENTS = [\n  'pl-question-panel',\n  'pl-multiple-choice',\n  'pl-checkbox',\n  'pl-integer-input',\n  'pl-number-input',\n  'pl-string-input',\n];\n\ninterface ElementSection {\n  elementName: string;\n  content: any[];\n}\n\nexport interface DocumentChunk {\n  text: string;\n  chunkId: string;\n}\n\nfunction stringify(content: any) {\n  return unified().use(remarkStringify).use(remarkGfm).stringify({\n    type: 'root',\n    children: content,\n  });\n}\n\nfunction extractElementSections(ast: any) {\n  const elementSections: ElementSection[] = [];\n\n  // Find the first level-three heading.\n  let startIndex = ast.children.findIndex((child) => {\n    return child.type === 'heading' && child.depth === 3;\n  });\n\n  if (startIndex === -1) {\n    throw new Error('No element sections found');\n  }\n\n  while (startIndex !== -1) {\n    const heading = ast.children[startIndex];\n\n    // All element headings should be level 3.\n    if (heading.type !== 'heading' || heading.depth !== 3) {\n      throw new Error('Expected heading');\n    }\n\n    // Element headings should contain an `inlineCode` node.\n    const inlineCode = heading.children[0];\n    if (inlineCode.type !== 'inlineCode') {\n      throw new Error('Expected inline code');\n    }\n\n    const elementName = inlineCode.value;\n\n    // Find the next level 2/3 heading.\n    let endIndex = ast.children.findIndex((child, index) => {\n      return (\n        index > startIndex && child.type === 'heading' && (child.depth === 2 || child.depth === 3)\n      );\n    });\n\n    // If there is no next heading, use the end of the document.\n    if (endIndex === -1) {\n      endIndex = ast.children.length;\n    }\n\n    const content = ast.children.slice(startIndex + 1, endIndex);\n    elementSections.push({ elementName, content });\n\n    startIndex = ast.children.findIndex((child, index) => {\n      return index >= endIndex && child.type === 'heading' && child.depth === 3;\n    });\n  }\n\n  return elementSections;\n}\n\nfunction removeHeadingAndContent(headingName: string, contents: any[]) {\n  const headingIndex = contents.findIndex((node) => {\n    return (\n      node.type === 'heading' &&\n      node.children[0].type === 'text' &&\n      node.children[0].value === headingName\n    );\n  });\n\n  // Nothing to do if the heading doesn't exist.\n  if (headingIndex === -1) return;\n\n  let nextHeadingIndex = contents.findIndex((node, index) => {\n    return index > headingIndex && node.type === 'heading';\n  });\n\n  // If there is no next heading, remove everything after the heading.\n  if (nextHeadingIndex === -1) {\n    nextHeadingIndex = contents.length;\n  }\n\n  contents.splice(headingIndex, nextHeadingIndex - headingIndex);\n}\n\nfunction cleanElementSections(elementSections: ElementSection[]) {\n  elementSections.forEach((section) => {\n    // Remove sections that aren't useful for the context.\n    removeHeadingAndContent('Example implementations', section.content);\n    removeHeadingAndContent('See also', section.content);\n\n    // Remove thematic breaks.\n    section.content = section.content.filter((node) => node.type !== 'thematicBreak');\n\n    // Rewrite all headings so that they can be nested under L2 headings.\n    section.content.forEach((node) => {\n      if (node.type === 'heading') {\n        // Safety check: all headings should be at least level 4.\n        if (node.depth < 4) {\n          console.error(section.content);\n          throw new Error('Expected heading to be at least level 4');\n        }\n        node.depth -= 1;\n      }\n      return node;\n    });\n    return section;\n  });\n\n  // Remove deprecated elements.\n  return elementSections.filter((section) => !DEPRECATED_ELEMENTS.has(section.elementName));\n}\n\nfunction writeOutTables(elementSections: ElementSection[]) {\n  elementSections.forEach((section) => {\n    section.content.forEach((node) => {\n      if (node.type === 'table') {\n        const firstRow = node.children[0];\n        if (\n          firstRow.children.length === 4 &&\n          firstRow.children[0].children[0].value === 'Attribute' &&\n          firstRow.children[1].children[0].value === 'Type' &&\n          firstRow.children[2].children[0].value === 'Default' &&\n          firstRow.children[3].children[0].value === 'Description'\n        ) {\n          const statements: any[] = [];\n          for (let rowIdx = 1; rowIdx < node.children.length; rowIdx++) {\n            const row = node.children[rowIdx];\n            const attribute = row.children[0];\n            const type = row.children[1];\n            const defaultValProcessed = stringify([row.children[2]]).trimEnd();\n            const defaultVal = row.children[2];\n            const description = row.children[3];\n\n            if (defaultValProcessed !== '-' && defaultValProcessed !== '—') {\n              statements.push(\n                attribute,\n                { type: 'text', value: ': of type ' },\n                type,\n                { type: 'text', value: ', default val: ' },\n                defaultVal,\n                { type: 'text', value: ', description: ' },\n                description,\n              );\n            } else {\n              statements.push(\n                attribute,\n                { type: 'text', value: ': of type ' },\n                type,\n                { type: 'text', value: ', description: ' },\n                description,\n              );\n            }\n\n            if (rowIdx < node.children.length - 1) {\n              statements.push({ type: 'text', value: '\\n' });\n            }\n          }\n          node.type = 'paragraph';\n          node.children = statements;\n        }\n      }\n      return node;\n    });\n    return section;\n  });\n  return elementSections;\n}\n\nexport async function buildContextForElementDocs(rawMarkdown: string): Promise<DocumentChunk[]> {\n  const file = unified().use(remarkParse).use(remarkGfm).parse(rawMarkdown);\n\n  const elementSections = writeOutTables(cleanElementSections(extractElementSections(file)));\n\n  const contexts = elementSections.map((section) => {\n    section.content.unshift({\n      type: 'heading',\n      depth: 2,\n      children: [{ type: 'text', value: section.elementName }],\n    });\n\n    const markdown = stringify(section.content);\n\n    return {\n      chunkId: section.elementName,\n      text: markdown,\n    };\n  });\n\n  return contexts.filter((x) => ALLOWED_ELEMENTS.includes(x.chunkId));\n}\n"]}