{"version":3,"file":"administratorInstitutionCourseInstance.js","sourceRoot":"","sources":["../../../../src/ee/pages/administratorInstitutionCourseInstance/administratorInstitutionCourseInstance.ts"],"names":[],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\nimport { loadSqlEquiv, queryAsync, queryRow } from '@prairielearn/postgres';\n\nimport { CourseInstanceSchema, CourseSchema } from '../../../lib/db-types.js';\nimport { parseDesiredPlanGrants } from '../../lib/billing/components/PlanGrantsEditor.html.js';\nimport {\n  getPlanGrantsForCourseInstance,\n  reconcilePlanGrantsForCourseInstance,\n} from '../../lib/billing/plans.js';\nimport { getInstitution } from '../../lib/institution.js';\n\nimport { AdministratorInstitutionCourseInstance } from './administratorInstitutionCourseInstance.html.js';\n\nconst sql = loadSqlEquiv(import.meta.url);\nconst router = Router({ mergeParams: true });\n\nasync function selectCourseInstanceAndCourseInInstitution({\n  institution_id,\n  unsafe_course_instance_id,\n}: {\n  institution_id: string;\n  unsafe_course_instance_id: string;\n}) {\n  return await queryRow(\n    sql.select_course_and_instance,\n    {\n      institution_id,\n      course_instance_id: unsafe_course_instance_id,\n    },\n    z.object({\n      course: CourseSchema,\n      course_instance: CourseInstanceSchema,\n    }),\n  );\n}\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    const institution = await getInstitution(req.params.institution_id);\n    const { course, course_instance } = await selectCourseInstanceAndCourseInInstitution({\n      institution_id: req.params.institution_id,\n      unsafe_course_instance_id: req.params.course_instance_id,\n    });\n    const planGrants = await getPlanGrantsForCourseInstance({\n      institution_id: institution.id,\n      course_instance_id: course_instance.id,\n    });\n    res.send(\n      AdministratorInstitutionCourseInstance({\n        institution,\n        course,\n        course_instance,\n        planGrants,\n        resLocals: res.locals,\n      }),\n    );\n  }),\n);\n\nrouter.post(\n  '/',\n  asyncHandler(async (req, res) => {\n    const { course_instance } = await selectCourseInstanceAndCourseInInstitution({\n      institution_id: req.params.institution_id,\n      unsafe_course_instance_id: req.params.course_instance_id,\n    });\n\n    if (req.body.__action === 'update_enrollment_limit') {\n      await queryAsync(sql.update_enrollment_limit, {\n        course_instance_id: course_instance.id,\n        enrollment_limit: req.body.enrollment_limit || null,\n      });\n      flash('success', 'Successfully updated enrollment limit.');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'update_plans') {\n      const desiredPlans = parseDesiredPlanGrants({\n        body: req.body,\n        // We exclude `basic` from the list of allowed plans because it should\n        // only ever be used for student billing for enrollments.\n        allowedPlans: ['compute', 'everything'],\n      });\n      await reconcilePlanGrantsForCourseInstance(\n        course_instance.id,\n        desiredPlans,\n        res.locals.authn_user.user_id,\n      );\n      flash('success', 'Successfully updated institution plan grants.');\n      res.redirect(req.originalUrl);\n    } else {\n      throw new error.HttpStatusError(400, `Unknown action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}