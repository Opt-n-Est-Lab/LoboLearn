{"version":3,"file":"administratorInstitutionLti13.html.js","sourceRoot":"","sources":["../../../../src/ee/pages/administratorInstitutionLti13/administratorInstitutionLti13.html.ts"],"names":[],"mappings":"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","sourcesContent":["import { EncodedData } from '@prairielearn/browser-utils';\nimport { html } from '@prairielearn/html';\n\nimport { PageLayout } from '../../../components/PageLayout.html.js';\nimport { compiledScriptTag } from '../../../lib/assets.js';\nimport { type Institution, type Lti13Instance } from '../../../lib/db-types.js';\n\nimport { type LTI13InstancePlatforms } from './administratorInstitutionLti13.types.js';\n\nexport function AdministratorInstitutionLti13({\n  institution,\n  lti13Instances,\n  instance,\n  resLocals,\n  platform_defaults,\n  canonicalHost,\n}: {\n  institution: Institution;\n  lti13Instances: Lti13Instance[];\n  instance: Lti13Instance | null;\n  resLocals: Record<string, any>;\n  platform_defaults: LTI13InstancePlatforms;\n  canonicalHost: string;\n}): string {\n  return PageLayout({\n    resLocals: {\n      ...resLocals,\n      institution,\n    },\n    pageTitle: 'LTI 1.3 - Institution Admin',\n    headContent: [compiledScriptTag('administratorInstitutionLti13Client.ts')],\n    navContext: {\n      type: 'administrator_institution',\n      page: 'administrator_institution',\n      subPage: 'lti13',\n    },\n    content: html`\n      <h2 class=\"h4\">LTI 1.3 / Learning Tools Interoperability</h2>\n      <p>${lti13Instances.length} instance${lti13Instances.length === 1 ? '' : 's'} configured.</p>\n      <hr />\n\n      <div class=\"row\">\n        <div class=\"col-3\">\n          ${lti13Instances.length > 0 ? 'Please select an instance:' : ''}\n\n          <nav class=\"nav nav-pills flex-column\">\n            ${lti13Instances.map((i) => {\n              return html`\n                <a class=\"nav-link ${i.id === instance?.id ? 'active' : ''}\" href=\"${i.id}\">\n                  <span style=\"white-space: nowrap\"> ${i.name ? i.name : `#${i.id}`} </span>\n                  <span style=\"white-space: nowrap\">(${i.platform})</span>\n                </a>\n              `;\n            })}\n          </nav>\n          <form method=\"POST\">\n            <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n            <button\n              class=\"btn btn-outline-success d-block w-100 my-4\"\n              type=\"submit\"\n              name=\"__action\"\n              value=\"add_instance\"\n            >\n              Add a new LTI 1.3 instance\n            </button>\n          </form>\n        </div>\n\n        <div class=\"col-9\">\n          ${LTI13Instance(instance, resLocals, platform_defaults, canonicalHost)}\n        </div>\n      </div>\n    `,\n  });\n}\n\nfunction LTI13Instance(\n  instance: Lti13Instance | null,\n  resLocals: Record<string, any>,\n  platform_defaults: LTI13InstancePlatforms,\n  canonicalHost: string,\n) {\n  if (instance) {\n    return html`\n      <h3>${instance.name} (ID #${instance.id})</h3>\n      <p>\n        Created at ${instance.created_at.toString()}\n        <button\n          class=\"btn btn-sm btn-secondary\"\n          type=\"button\"\n          data-bs-toggle=\"modal\"\n          data-bs-target=\"#instanceData\"\n        >\n          <i class=\"fa-solid fa-screwdriver-wrench\"></i> Show details\n        </button>\n      </p>\n\n      <div class=\"modal fade\" id=\"instanceData\" tabindex=\"-1\" aria-hidden=\"true\">\n        <div class=\"modal-dialog modal-xl modal-dialog-scrollable\">\n          <div class=\"modal-content\">\n            <div class=\"modal-header\">\n              <h5 class=\"modal-title\">LTI 1.3 instance data</h5>\n              <button\n                type=\"button\"\n                class=\"btn-close\"\n                data-bs-dismiss=\"modal\"\n                aria-label=\"Close\"\n              ></button>\n            </div>\n            <div class=\"modal-body\">\n              <pre><code>${JSON.stringify(instance, null, 1)}</code></pre>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p>\n        <a href=\"${canonicalHost}/pl/lti13_instance/${instance.id}/config\"\n          >LTI 1.3 config for instance</a\n        >\n        |\n        <a href=\"${canonicalHost}/pl/lti13_instance/${instance.id}/jwks\">JWKS keystore link</a>\n        (${instance.keystore?.keys ? instance.keystore.keys.length : 0}\n        key${instance.keystore?.keys?.length === 1 ? '' : 's'})\n      </p>\n\n      <hr />\n      <h5>Name:</h5>\n      ${instance.tool_platform_name\n        ? html` The LMS has referred to itself as:\n            <strong>${instance.tool_platform_name}</strong>`\n        : ''}\n      <form class=\"form\" method=\"POST\">\n        <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n        <input type=\"hidden\" name=\"__action\" value=\"update_name\" />\n        <div class=\"mb-3 my-2\">\n          <label for=\"name\" class=\"form-label\">Branded platform name: </label>\n          <input\n            id=\"name\"\n            class=\"form-control\"\n            type=\"text\"\n            size=\"80\"\n            spellcheck=\"false\"\n            name=\"name\"\n            value=\"${instance.name}\"\n            aria-describedby=\"nameHelp\"\n          />\n          <small id=\"nameHelp\" class=\"form-text text-muted\">\n            Use this name inside PL to refer to the LMS, i.e. whatever your institution calls it\n          </small>\n        </div>\n        <button class=\"btn btn-info\">Save name</button>\n        <input type=\"reset\" class=\"btn btn-secondary\" value=\"Reset options\" />\n      </form>\n\n      <hr />\n      <h5>Platform:</h5>\n\n      ${EncodedData(platform_defaults, 'platform_defaults_data')}\n\n      <form class=\"form\" method=\"POST\">\n        <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n        <input type=\"hidden\" name=\"__action\" value=\"update_platform\" />\n\n        <div class=\"mb-3\">\n          <label class=\"form-label\" for=\"choosePlatform\">Platform type: </label>\n          <select class=\"form-select mb-2\" id=\"choosePlatform\" name=\"platform\">\n            ${platform_defaults.map((d) => {\n              return html`<option ${d.platform === instance.platform ? 'selected' : ''}>\n                ${d.platform}\n              </option>`;\n            })}\n          </select>\n\n          <div class=\"form-check form-check-inline\">\n            <label class=\"form-check-label\">\n              <input\n                id=\"update_params\"\n                class=\"form-check-input\"\n                type=\"checkbox\"\n                name=\"platform_update\"\n                value=\"1\"\n                checked\n              />\n              On change, load defaults into form&nbsp;<em>(remember to edit and save!)</em>\n            </label>\n          </div>\n        </div>\n\n        <div class=\"mb-3 mt-2\">\n          <label for=\"issuer_params\"> Issuer params: </label>\n          <textarea\n            class=\"form-control\"\n            id=\"issuer_params\"\n            name=\"issuer_params\"\n            rows=\"8\"\n            spellcheck=\"false\"\n          >\n${JSON.stringify(instance.issuer_params, null, 3)}</textarea\n          >\n        </div>\n\n        <div class=\"mb-3 mt-2\">\n          <label for=\"client_id\">Client ID: </label>\n          <input\n            id=\"client_id\"\n            class=\"form-control\"\n            type=\"text\"\n            spellcheck=\"false\"\n            name=\"client_id\"\n            value=\"${instance.client_params?.client_id}\"\n            aria-describedby=\"client_idHelp\"\n          />\n          <small id=\"client_idHelp\" class=\"form-text text-muted\">\n            Get this unique ID from the LMS.\n          </small>\n        </div>\n\n        <div class=\"mb-3 mt-2\">\n          <label for=\"custom_fields\">Custom fields suggestions: </label>\n          <textarea\n            class=\"form-control\"\n            id=\"custom_fields\"\n            name=\"custom_fields\"\n            rows=\"4\"\n            spellcheck=\"false\"\n          >\n${JSON.stringify(instance.custom_fields, null, 3)}</textarea\n          >\n          <small id=\"custom_fieldsHelp\" class=\"form-text text-muted\">\n            Provide suggestions to the LMS in the config JSON for how to setup LTI 1.3 custom\n            fields.\n            <a\n              href=\"https://canvas.instructure.com/doc/api/file.tools_variable_substitutions.html\"\n              target=\"_blank\"\n              >Canvas variable substitution docs</a\n            >\n          </small>\n        </div>\n\n        <div class=\"mb-3\">\n          <button class=\"btn btn-info\">Save platform options</button>\n          <input type=\"reset\" class=\"btn btn-secondary\" value=\"Reset options\" />\n        </div>\n      </form>\n\n      <hr />\n      <h5>Keystore:</h5>\n\n      <a href=\"${canonicalHost}/pl/lti13_instance/${instance.id}/jwks\">JWKS keystore</a>\n      contains ${instance.keystore?.keys ? instance.keystore.keys.length : 0}\n      key${instance.keystore?.keys?.length === 1 ? '' : 's'}.<br />\n      <ul>\n        ${instance.keystore?.keys?.map((k) => {\n          return html`<li>\n            <form method=\"POST\">\n              <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n              <input type=\"hidden\" name=\"__action\" value=\"delete_key\" />\n              <input type=\"hidden\" name=\"kid\" value=\"${k.kid}\" />\n              ${k.kid}\n              <input\n                class=\"btn btn-xs btn-outline-warning\"\n                type=\"submit\"\n                value=\"Delete key\"\n                onClick=\"return confirm('Really delete this key: ${k.kid}?')\"\n              />\n            </form>\n          </li>`;\n        })}\n      </ul>\n      <form method=\"POST\">\n        <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n        <button type=\"submit\" name=\"__action\" value=\"add_key\" class=\"btn btn-success\">\n          Add key to keystore\n        </button>\n        <button\n          type=\"submit\"\n          name=\"__action\"\n          value=\"delete_keys\"\n          class=\"btn btn-warning\"\n          onClick=\"return confirm('Really delete all keys from keystore?')\"\n        >\n          Delete all keys from keystore\n        </button>\n      </form>\n\n      <hr />\n      <h5>PrairieLearn configuration</h5>\n\n      <form method=\"POST\">\n        <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n        <input type=\"hidden\" name=\"__action\" value=\"save_pl_config\" />\n\n        <h6>Which attributes from the LTI 1.3 user claim should be mapped to PL identities?</h6>\n        <div class=\"mb-3\">\n          <label class=\"form-label\" for=\"name_attribute\">Name attribute</label>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            name=\"name_attribute\"\n            id=\"name_attribute\"\n            value=\"${instance.name_attribute}\"\n            aria-describedby=\"nameAttributeHelp\"\n          />\n          <small id=\"nameAttributeHelp\" class=\"form-text text-muted\">\n            This attribute should contain the full name of the user, like \"Jasmine Wang\".\n          </small>\n        </div>\n\n        <div class=\"mb-3\">\n          <label class=\"form-label\" for=\"name_attribute\">UID attribute</label>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            name=\"uid_attribute\"\n            id=\"uid_attribute\"\n            value=\"${instance.uid_attribute}\"\n            aria-describedby=\"uidAttributeHelp\"\n          />\n          <small id=\"uidAttributeHelp\" class=\"form-text text-muted\">\n            The UID is a user-facing identifier for the user. This should generally be an email-like\n            identifier, like \"jwang@example.com\". However, it doesn't have to be an email address;\n            PrairieLearn will never try to route email to it. This attribute may change, for\n            instance if a student changes their name with their university.\n          </small>\n        </div>\n\n        <div class=\"mb-3\">\n          <label class=\"form-label\" for=\"name_attribute\">UIN attribute</label>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            name=\"uin_attribute\"\n            id=\"uin_attribute\"\n            value=\"${instance.uin_attribute}\"\n            aria-describedby=\"uinAttributeHelp\"\n          />\n          <small id=\"uinAttributeHelp\" class=\"form-text text-muted\">\n            The UIN is used as an internal, immutable identifier for the user. It\n            <strong>MUST</strong> never change for a given individual, even if they change their\n            name or UID. Possibly\n            <code>[\"https://purl.imsglobal.org/spec/lti/claim/lis\"][\"person_sourcedid\"]</code> or\n            <code>[\"https://purl.imsglobal.org/spec/lti/claim/custom\"][\"uin\"]</code>\n          </small>\n        </div>\n\n        <div class=\"mb-3\">\n          <label class=\"form-label\" for=\"name_attribute\">Email attribute</label>\n          <input\n            type=\"text\"\n            class=\"form-control\"\n            name=\"email_attribute\"\n            id=\"email_attribute\"\n            value=\"${instance.email_attribute}\"\n            aria-describedby=\"emailAttributeHelp\"\n          />\n          <small id=\"emailAttributeHelp\" class=\"form-text text-muted\">\n            This attribute should contain the email address of the user. If present, PrairieLearn\n            will use this to send email to the user.\n          </small>\n        </div>\n\n        <button class=\"btn btn-info\">Save PrairieLearn config</button>\n      </form>\n\n      <hr />\n      <p>\n        For testing, have the LMS admin configure their OpenID Connect Initiation URL to\n        <a href=\"${canonicalHost}/pl/lti13_instance/${instance.id}/auth/login?test\">\n          ${canonicalHost}/pl/lti13_instance/${instance.id}/auth/login?test\n        </a>\n      </p>\n\n      <form method=\"POST\">\n        <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n        <input type=\"hidden\" name=\"__action\" value=\"remove_instance\" />\n        <button\n          class=\"btn btn-danger my-2\"\n          onClick=\"return confirm('Really delete this LTI 1.3 instance?')\"\n        >\n          Remove LTI 1.3 instance\n        </button>\n      </form>\n    `;\n  } else {\n    return html`Please select an instance on the left.`;\n  }\n}\n"]}