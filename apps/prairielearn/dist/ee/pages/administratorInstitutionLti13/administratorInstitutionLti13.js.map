{"version":3,"file":"administratorInstitutionLti13.js","sourceRoot":"","sources":["../../../../src/ee/pages/administratorInstitutionLti13/administratorInstitutionLti13.ts"],"names":[],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\nimport _ from 'lodash';\nimport jose from 'node-jose';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\nimport { loadSqlEquiv, queryAsync, queryRows } from '@prairielearn/postgres';\n\nimport { config } from '../../../lib/config.js';\nimport { type Lti13Instance, Lti13InstanceSchema } from '../../../lib/db-types.js';\nimport { getCanonicalHost } from '../../../lib/url.js';\nimport { getInstitution } from '../../lib/institution.js';\n\nimport { AdministratorInstitutionLti13 } from './administratorInstitutionLti13.html.js';\nimport { type LTI13InstancePlatforms } from './administratorInstitutionLti13.types.js';\n\nconst sql = loadSqlEquiv(import.meta.url);\nconst router = Router({ mergeParams: true });\n\nconst lti13_instance_defaults = {\n  name_attr: 'name',\n  uid_attr: 'email',\n  uin_attr: '[\"https://purl.imsglobal.org/spec/lti/claim/custom\"][\"uin\"]',\n  email_attr: 'email',\n};\n\n// Middleware to check for feature and access\nrouter.use(\n  asyncHandler(async (req, res, next) => {\n    if (!res.locals.lti13_enabled) {\n      throw new error.HttpStatusError(403, 'Access denied (feature not available)');\n    }\n    next();\n  }),\n);\n\nrouter.get(\n  '/:unsafe_lti13_instance_id?',\n  asyncHandler(async (req, res) => {\n    const institution = await getInstitution(req.params.institution_id);\n    const lti13Instances = await queryRows(\n      sql.select_instances,\n      {\n        institution_id: req.params.institution_id,\n      },\n      Lti13InstanceSchema,\n    );\n\n    const platform_defaults_hardcoded: LTI13InstancePlatforms = [\n      {\n        platform: 'Unknown',\n        display_order: 0,\n        issuer_params: {},\n      },\n      {\n        platform: 'Canvas Production',\n        display_order: 10,\n        issuer_params: {\n          issuer: 'https://canvas.instructure.com',\n          jwks_uri: 'https://sso.canvaslms.com/api/lti/security/jwks',\n          token_endpoint: 'https://sso.canvaslms.com/login/oauth2/token',\n          authorization_endpoint: 'https://sso.canvaslms.com/api/lti/authorize_redirect',\n        },\n        custom_fields: {\n          uin: '$Canvas.user.sisIntegrationId',\n        },\n      },\n    ];\n\n    const platform_defaults = _.sortBy(\n      [...platform_defaults_hardcoded, ...config.lti13InstancePlatforms],\n      ['display_order', 'platform'],\n    );\n\n    let paramInstance: Lti13Instance | undefined;\n\n    // Handle the / (no id passed case)\n    if (typeof req.params.unsafe_lti13_instance_id === 'undefined') {\n      if (lti13Instances.length > 0) {\n        return res.redirect(\n          `/pl/administrator/institution/${institution.id}/lti13/${lti13Instances[0].id}`,\n        );\n      }\n      // else continue through, the html.ts page handles the 0 instances case\n    } else {\n      // id passed should be valid\n      paramInstance = lti13Instances.find(({ id }) => id === req.params.unsafe_lti13_instance_id);\n\n      if (!paramInstance) {\n        throw new error.HttpStatusError(\n          404,\n          `LTI 1.3 instance ${req.params.unsafe_lti13_instance_id} not found`,\n        );\n      }\n    }\n\n    res.send(\n      AdministratorInstitutionLti13({\n        institution,\n        lti13Instances,\n        instance: paramInstance ?? null,\n        resLocals: res.locals,\n        platform_defaults,\n        canonicalHost: getCanonicalHost(req),\n      }),\n    );\n  }),\n);\n\nrouter.post(\n  '/:unsafe_lti13_instance_id?',\n  asyncHandler(async (req, res) => {\n    if (req.body.__action === 'add_key') {\n      const keystoreJson = await queryAsync(sql.select_keystore, {\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n        institution_id: req.params.institution_id,\n      });\n      const keystore = await jose.JWK.asKeyStore(keystoreJson?.rows[0]?.keystore || []);\n\n      const kid = new Date().toUTCString();\n      // RSA256 minimum keysize of 2048 bits\n      await keystore.generate('RSA', 2048, {\n        alg: 'RS256',\n        use: 'sig',\n        kid,\n      });\n\n      await queryAsync(sql.update_keystore, {\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n        institution_id: req.params.institution_id,\n        // true to include private keys\n        keystore: keystore.toJSON(true),\n      });\n      flash('success', `Key ${kid} added.`);\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'delete_keys') {\n      await queryAsync(sql.update_keystore, {\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n        institution_id: req.params.institution_id,\n        keystore: null,\n      });\n      flash('success', 'All keys deleted.');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'delete_key') {\n      const keystoreJson = await queryAsync(sql.select_keystore, {\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n        institution_id: req.params.institution_id,\n      });\n      const keystore = await jose.JWK.asKeyStore(keystoreJson?.rows[0]?.keystore || []);\n\n      const key = keystore.get(req.body.kid);\n\n      // Validate the key before removal because keystore.get() returns the first key\n      if (req.body.kid === key.kid) {\n        keystore.remove(key);\n\n        await queryAsync(sql.update_keystore, {\n          unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n          institution_id: req.params.institution_id,\n          // true to include private keys\n          keystore: keystore.toJSON(true),\n        });\n        flash('success', `Key ${key.kid} deleted.`);\n        return res.redirect(req.originalUrl);\n      } else {\n        throw new error.HttpStatusError(500, 'error removing key');\n      }\n    } else if (req.body.__action === 'update_platform') {\n      const url = getCanonicalHost(req);\n\n      const client_params = {\n        client_id: req.body.client_id || null,\n        redirect_uris: [\n          `${url}/pl/lti13_instance/${req.params.unsafe_lti13_instance_id}/auth/callback`,\n        ],\n        token_endpoint_auth_method: 'private_key_jwt',\n        token_endpoint_auth_signing_alg: 'RS256',\n      };\n\n      await queryAsync(sql.update_platform, {\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n        institution_id: req.params.institution_id,\n        issuer_params: req.body.issuer_params,\n        platform: req.body.platform,\n        client_params,\n        custom_fields: req.body.custom_fields,\n      });\n      flash('success', 'Platform updated.');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'add_instance') {\n      const new_li = await queryRows(\n        sql.insert_instance,\n        {\n          ...lti13_instance_defaults,\n          institution_id: req.params.institution_id,\n        },\n        z.string(),\n      );\n      flash('success', `Instance #${new_li} added.`);\n\n      return res.redirect(\n        `/pl/administrator/institution/${req.params.institution_id}/lti13/${new_li}`,\n      );\n    } else if (req.body.__action === 'update_name') {\n      await queryAsync(sql.update_name, {\n        name: req.body.name,\n        institution_id: req.params.institution_id,\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n      });\n      flash('success', 'Name updated.');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'save_pl_config') {\n      await queryAsync(sql.update_pl_config, {\n        name_attribute: req.body.name_attribute,\n        uid_attribute: req.body.uid_attribute,\n        uin_attribute: req.body.uin_attribute,\n        email_attribute: req.body.email_attribute,\n        institution_id: req.params.institution_id,\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n      });\n      flash('success', 'PrairieLearn config updated.');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'remove_instance') {\n      await queryAsync(sql.remove_instance, {\n        institution_id: req.params.institution_id,\n        unsafe_lti13_instance_id: req.params.unsafe_lti13_instance_id,\n      });\n      flash('success', 'Instance deleted.');\n      return res.redirect(req.originalUrl);\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}