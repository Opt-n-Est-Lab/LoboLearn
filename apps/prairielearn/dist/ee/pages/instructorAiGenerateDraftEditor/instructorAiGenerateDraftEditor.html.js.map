{"version":3,"file":"instructorAiGenerateDraftEditor.html.js","sourceRoot":"","sources":["../../../../src/ee/pages/instructorAiGenerateDraftEditor/instructorAiGenerateDraftEditor.html.ts"],"names":[],"mappings":"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","sourcesContent":["import { html } from '@prairielearn/html';\nimport { run } from '@prairielearn/run';\n\nimport { HeadContents } from '../../../components/HeadContents.html.js';\nimport { Modal } from '../../../components/Modal.html.js';\nimport { Navbar } from '../../../components/Navbar.html.js';\nimport { QuestionContainer } from '../../../components/QuestionContainer.html.js';\nimport {\n  compiledScriptTag,\n  compiledStylesheetTag,\n  nodeModulesAssetPath,\n} from '../../../lib/assets.js';\nimport { b64EncodeUnicode } from '../../../lib/base64-util.js';\nimport { type AiQuestionGenerationPrompt, type Question } from '../../../lib/db-types.js';\n\nexport function InstructorAiGenerateDraftEditor({\n  resLocals,\n  prompts,\n  question,\n  variantId,\n}: {\n  resLocals: Record<string, any>;\n  prompts: AiQuestionGenerationPrompt[];\n  question: Question;\n  variantId?: string | undefined;\n}) {\n  // This page has a very custom layout, so we don't use the usual `PageLayout`\n  // component here. If we start building other similar pages, we might want to\n  // teach `PageLayout` how to render this kind of layout.\n  return html`\n    <!doctype html>\n    <html lang=\"en\">\n      <head>\n        <meta\n          name=\"ace-base-path\"\n          content=\"${nodeModulesAssetPath('ace-builds/src-min-noconflict/')}\"\n        />\n        ${[\n          HeadContents({ resLocals }),\n          compiledScriptTag('question.ts'),\n          compiledScriptTag('instructorAiGenerateDraftEditorClient.ts'),\n          compiledStylesheetTag('instructorAiGenerateDraftEditor.css'),\n        ]}\n        <script defer src=\"${nodeModulesAssetPath('mathjax/es5/startup.js')}\"></script>\n      </head>\n      <body hx-ext=\"loading-states\">\n        <div class=\"app-container\">\n          <div class=\"app-grid\">\n            <div class=\"app-navbar\">\n              ${Navbar({\n                navPage: 'course_admin',\n                navSubPage: 'questions',\n                resLocals,\n                marginBottom: false,\n              })}\n            </div>\n            <main id=\"content\" class=\"app-content\">\n              <div class=\"d-flex flex-row align-items-center p-2 bg-light border-bottom app-back\">\n                <a\n                  href=\"${resLocals.urlPrefix}/ai_generate_question_drafts\"\n                  class=\"btn btn-sm btn-ghost\"\n                >\n                  <i class=\"fa fa-arrow-left\" aria-hidden=\"true\"></i>\n                  Back to AI questions\n                </a>\n              </div>\n              <div class=\"app-chat p-2 bg-light border-end\">\n                <div class=\"app-chat-history\">\n                  ${PromptHistory({\n                    prompts,\n                    urlPrefix: resLocals.urlPrefix,\n                    csrfToken: resLocals.__csrf_token,\n                    showJobLogs: resLocals.is_administrator,\n                  })}\n                </div>\n                <div class=\"app-chat-prompt mt-2\">\n                  <form\n                    class=\"js-revision-form\"\n                    hx-post=\"${variantId\n                      ? html`${resLocals.urlPrefix}/ai_generate_editor/${question.id}?variant_id=${variantId}`\n                      : html`${resLocals.urlPrefix}/ai_generate_editor/${question.id}`}\"\n                    hx-swap=\"outerHTML\"\n                    hx-disabled-elt=\"button\"\n                  >\n                    <input type=\"hidden\" name=\"__csrf_token\" value=\"${resLocals.__csrf_token}\" />\n                    <input type=\"hidden\" name=\"__action\" value=\"regenerate_question\" />\n                    <textarea\n                      name=\"prompt\"\n                      id=\"user-prompt-llm\"\n                      class=\"form-control mb-2\"\n                      placeholder=\"What would you like to revise?\"\n                      aria-label=\"Modification instructions\"\n                      required\n                    ></textarea>\n                    <button type=\"submit\" class=\"btn btn-dark w-100\">\n                      <span\n                        class=\"spinner-grow spinner-grow-sm d-none me-1\"\n                        role=\"status\"\n                        aria-hidden=\"true\"\n                        data-loading-class-remove=\"d-none\"\n                      ></span>\n                      Revise question\n                    </button>\n                    <div class=\"text-muted small text-center mt-1\">\n                      AI can make mistakes. Review the generated question.\n                    </div>\n                  </form>\n                </div>\n              </div>\n\n              <div class=\"d-flex flex-row align-items-stretch bg-light app-preview-tabs\">\n                <ul class=\"nav nav-tabs me-auto ps-2 pt-2\">\n                  <li class=\"nav-item\">\n                    <a\n                      class=\"nav-link active\"\n                      data-bs-toggle=\"tab\"\n                      aria-current=\"page\"\n                      href=\"#question-preview\"\n                    >\n                      Preview\n                    </a>\n                  </li>\n                  <li class=\"nav-item\">\n                    <a a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#question-code\">Files</a>\n                  </li>\n                </ul>\n                <div\n                  class=\"d-flex align-items-center justify-content-end flex-grow-1 border-bottom pe-2\"\n                >\n                  <span data-bs-toggle=\"modal\" data-bs-target=\"#finalizeModal\">\n                    <button\n                      type=\"button\"\n                      class=\"btn btn-sm btn-primary\"\n                      data-bs-toggle=\"tooltip\"\n                      data-bs-title=\"Finalize a question to use it on assessments and make manual edits\"\n                    >\n                      <i class=\"fa fa-check\" aria-hidden=\"true\"></i>\n                      Finalize question\n                    </button>\n                  </span>\n                </div>\n              </div>\n              <div class=\"app-preview\">${QuestionAndFilePreview({ resLocals, prompts })}</div>\n            </main>\n          </div>\n        </div>\n        ${FinalizeModal({ csrfToken: resLocals.__csrf_token })}\n      </body>\n      <script>\n        // TODO: something different on narrow viewports?\n        const chatHistory = document.querySelector('.app-chat-history');\n        chatHistory.scrollTop = chatHistory.scrollHeight;\n      </script>\n    </html>\n  `.toString();\n}\n\nfunction PromptHistory({\n  prompts,\n  urlPrefix,\n  csrfToken,\n  showJobLogs,\n}: {\n  prompts: AiQuestionGenerationPrompt[];\n  urlPrefix: string;\n  csrfToken: string;\n  showJobLogs: boolean;\n}) {\n  return prompts.map((prompt, index, filteredPrompts) => {\n    // TODO: Once we can upgrade to Bootstrap 5.3, we can use the official\n    // `bg-secondary-subtle` class instead of the custom styles here.\n    return html`\n      <div class=\"d-flex flex-row-reverse\">\n        <div class=\"p-3 mb-2 rounded\" style=\"background: #e2e3e5; max-width: 90%\">\n          ${run(() => {\n            // We'll special-case these two \"prompts\" and show a custom italic\n            // message\n            // Differentiate between actual text typed by the user and the\n            // system-generated prompts.\n            if (prompt.prompt_type === 'manual_revert') {\n              return html`<i>Revert to an earlier revision.</i>`;\n            }\n\n            if (prompt.prompt_type === 'manual_change') {\n              return html`<i>Edit the question files.</i>`;\n            }\n\n            return prompt.user_prompt;\n          })}\n        </div>\n      </div>\n      <div\n        class=\"d-flex flex-row justify-content-start align-items-start py-3 ps-3 mb-2 prompt-response\"\n      >\n        <div>\n          ${run(() => {\n            if (prompt.prompt_type === 'initial') {\n              return \"A new question has been generated. Review the preview and prompt for any necessary revisions. Once you're happy with the question, finalize it to use it on an assessment.\";\n            }\n\n            if (prompt.prompt_type === 'manual_revert') {\n              return 'The question has been reverted to an earlier revision. Make further revisions or finalize the question.';\n            }\n\n            if (prompt.prompt_type === 'manual_change') {\n              return 'Your manual edits have been applied. Make further revisions or finalize the question.';\n            }\n\n            return 'The question has been revised. Make further revisions or finalize the question.';\n          })}\n          <div>\n            ${run(() => {\n              if (!showJobLogs || !prompt.job_sequence_id) return '';\n\n              const jobLogsUrl = urlPrefix + '/jobSequence/' + prompt.job_sequence_id;\n\n              return html`<a class=\"small\" href=\"${jobLogsUrl}\" target=\"_blank\">\n                View job logs\n              </a>`;\n            })}\n          </div>\n        </div>\n        ${run(() => {\n          // There's no point showing an option to revert to the most recent prompt.\n          if (index === filteredPrompts.length - 1) return '';\n\n          return html`\n            <form method=\"post\">\n              <input type=\"hidden\" name=\"__action\" value=\"revert_edit_version\" />\n              <input type=\"hidden\" name=\"unsafe_prompt_id\" value=\"${prompt.id}\" />\n              <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n              <button\n                type=\"submit\"\n                class=\"btn btn-sm btn-ghost revert-to-revision-button\"\n                data-bs-toggle=\"tooltip\"\n                data-bs-title=\"Revert to this revision\"\n              >\n                <i class=\"fa fa-undo\" aria-hidden=\"true\"></i>\n              </button>\n            </form>\n          `;\n        })}\n      </div>\n    `;\n  });\n}\n\nfunction QuestionAndFilePreview({\n  prompts,\n  resLocals,\n}: {\n  prompts: AiQuestionGenerationPrompt[];\n  resLocals: Record<string, any>;\n}) {\n  return html`\n    <div class=\"tab-content\" style=\"height: 100%\">\n      <div role=\"tabpanel\" id=\"question-preview\" class=\"tab-pane active\" style=\"height: 100%\">\n        <div class=\"question-wrapper mx-auto p-3\">\n          ${QuestionContainer({ resLocals, questionContext: 'instructor' })}\n        </div>\n      </div>\n      <div role=\"tabpanel\" id=\"question-code\" class=\"tab-pane\" style=\"height: 100%\">\n        ${QuestionCodeEditors({\n          htmlContents: prompts[prompts.length - 1].html,\n          pythonContents: prompts[prompts.length - 1].python,\n          csrfToken: resLocals.__csrf_token,\n        })}\n      </div>\n    </div>\n  `;\n}\n\nfunction QuestionCodeEditors({\n  htmlContents,\n  pythonContents,\n  csrfToken,\n}: {\n  htmlContents: string | null;\n  pythonContents: string | null;\n  csrfToken: string;\n}) {\n  return html`\n    <div class=\"editor-panes p-2 gap-2\">\n      <!-- TODO: Move this to a more sensible location -->\n      <div class=\"editor-pane-status\">\n        <div class=\"d-flex flex-row align-items-center justify-content-between ps-2\">\n          <span class=\"js-editor-status\">No unsaved changes.</span>\n          <form method=\"post\" class=\"js-editor-form\">\n            <input type=\"hidden\" name=\"__action\" value=\"submit_manual_revision\" />\n            <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n            <button type=\"submit\" class=\"btn btn-sm btn-primary\">Save edits</button>\n            <input\n              type=\"hidden\"\n              class=\"js-file-editor-contents\"\n              name=\"html\"\n              value=\"${b64EncodeUnicode(htmlContents ?? '')}\"\n            />\n            <input\n              type=\"hidden\"\n              class=\"js-file-editor-contents\"\n              name=\"python\"\n              value=\"${b64EncodeUnicode(pythonContents ?? '')}\"\n            />\n          </form>\n        </div>\n      </div>\n      <div class=\"editor-pane-html d-flex flex-column border rounded\" style=\"overflow: hidden\">\n        <div class=\"py-2 px-3 font-monospace bg-light\">question.html</div>\n        <div\n          class=\"js-file-editor flex-grow-1\"\n          data-ace-mode=\"ace/mode/html\"\n          data-input-contents-name=\"html\"\n        ></div>\n      </div>\n      <div class=\"editor-pane-python d-flex flex-column border rounded\" style=\"overflow: hidden\">\n        <div class=\"py-2 px-3 font-monospace bg-light\">server.py</div>\n        <div\n          class=\"js-file-editor flex-grow-1\"\n          data-ace-mode=\"ace/mode/python\"\n          data-input-contents-name=\"python\"\n        ></div>\n      </div>\n    </div>\n  `;\n}\n\nfunction FinalizeModal({ csrfToken }: { csrfToken: string }) {\n  return Modal({\n    id: 'finalizeModal',\n    title: 'Finalize question',\n    body: html`\n      <div class=\"alert alert-primary\" role=\"alert\">\n        After finalizing the question, you will be able to use it on assessments and make manual\n        edits.\n      </div>\n      <div class=\"mb-3\">\n        <label for=\"title\" class=\"form-label\">Title</label>\n        <input type=\"text\" class=\"form-control\" id=\"question-title\" name=\"title\" required />\n        <div class=\"form-text text-muted\">\n          The title of the question as it will appear in the question bank, e.g. \"Add two random\n          numbers\".\n        </div>\n      </div>\n      <div class=\"mb-3\">\n        <label for=\"qid\" class=\"form-label\">QID</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"question-qid\"\n          name=\"qid\"\n          pattern=\"[\\\\-A-Za-z0-9_\\\\/]+\"\n          required\n        />\n        <div class=\"form-text text-muted\">\n          A unique identifier that will be used to include this question in assessments, e.g.\n          <code>add-random-numbers</code>.\n        </div>\n      </div>\n    `,\n    footer: html`\n      <input type=\"hidden\" name=\"__action\" value=\"save_question\" />\n      <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n      <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\n      <button class=\"btn btn-primary\">Finalize question</button>\n    `,\n  });\n}\n"]}