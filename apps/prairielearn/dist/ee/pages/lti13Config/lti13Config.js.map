{"version":3,"file":"lti13Config.js","sourceRoot":"","sources":["../../../../src/ee/pages/lti13Config/lti13Config.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,GAAG,EAAE,MAAM,KAAK,CAAC;AAE1B,OAAO,EAAE,MAAM,EAAE,MAAM,SAAS,CAAC;AACjC,OAAO,YAAY,MAAM,uBAAuB,CAAC;AAEjD,OAAO,EAAE,gBAAgB,EAAE,MAAM,qBAAqB,CAAC;AACvD,OAAO,EAAE,mBAAmB,EAAE,MAAM,+BAA+B,CAAC;AAEpE,MAAM,MAAM,GAAG,MAAM,CAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;AAE7C,MAAM,SAAS,GAAG;IAChB,KAAK,EAAE,cAAc;IACrB,WAAW,EAAE,0CAA0C;IACvD,mBAAmB,EAAE,qCAAqC;IAC1D,eAAe,EAAE,qCAAqC;IACtD,UAAU,EAAE;QACV;YACE,MAAM,EAAE,SAAS;YACjB,QAAQ,EAAE,wBAAwB;YAClC,aAAa,EAAE,QAAQ;YACvB,QAAQ,EAAE;gBACR,IAAI,EAAE,cAAc;gBACpB,UAAU,EAAE;oBACV;wBACE,IAAI,EAAE,cAAc;wBACpB,OAAO,EAAE,IAAI;wBACb,SAAS,EAAE,mBAAmB;wBAC9B,OAAO,EAAE,UAAU;wBACnB,YAAY,EAAE,wBAAwB;wBACtC,eAAe,EAAE,qCAAqC;wBACtD,YAAY,EAAE,QAAQ;qBACvB;iBACF;aACF;SACF;KACF;IACD,aAAa,EAAE,EAAE;IACjB,cAAc,EAAE,qCAAqC;IACrD,MAAM,EAAE;QACN,wDAAwD;QACxD,qDAAqD;QACrD,2EAA2E;KAC5E;CACF,CAAC;AAEF,MAAM,CAAC,GAAG,CACR,GAAG,EACH,YAAY,CAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE;IAC9B,uFAAuF;IACvF,yFAAyF;IACzF,EAAE;IACF,sGAAsG;IACtG,EAAE;IACF,oFAAoF;IAEpF,MAAM,cAAc,GAAG,MAAM,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC;IAE/E,MAAM,SAAS,GAAG,eAAe,CAAC,SAAS,CAAC,CAAC;IAC7C,MAAM,IAAI,GAAG,gBAAgB,CAAC,GAAG,CAAC,CAAC;IACnC,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,CAAC;IAE1B,SAAS,CAAC,mBAAmB,GAAG,GAAG,IAAI,sBAAsB,cAAc,CAAC,EAAE,aAAa,CAAC;IAC5F,SAAS,CAAC,eAAe,GAAG,GAAG,IAAI,sBAAsB,cAAc,CAAC,EAAE,gBAAgB,CAAC;IAE3F,uCAAuC;IACvC,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,QAAQ,IAAI,EAAE,CAAC;IACpD,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,eAAe,GAAG,GAAG,IAAI,sBAAsB,cAAc,CAAC,EAAE,oBAAoB,CAAC;IAEpI,SAAS,CAAC,cAAc,GAAG,GAAG,IAAI,sBAAsB,cAAc,CAAC,EAAE,OAAO,CAAC;IACjF,SAAS,CAAC,aAAa,GAAG,cAAc,CAAC,aAAa,CAAC;IAEvD,GAAG,CAAC,SAAS,CAAC,cAAc,EAAE,kBAAkB,CAAC,CAAC;IAClD,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;AAC9C,CAAC,CAAC,CACH,CAAC;AAEF,eAAe,MAAM,CAAC","sourcesContent":["import { URL } from 'url';\n\nimport { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport { getCanonicalHost } from '../../../lib/url.js';\nimport { selectLti13Instance } from '../../models/lti13Instance.js';\n\nconst router = Router({ mergeParams: true });\n\nconst ltiConfig = {\n  title: 'PrairieLearn',\n  description: 'The best platform for online assessments',\n  oidc_initiation_url: 'PLACEHOLDER--will be replaced later',\n  target_link_uri: 'PLACEHOLDER--will be replaced later',\n  extensions: [\n    {\n      domain: 'replace',\n      platform: 'canvas.instructure.com',\n      privacy_level: 'public',\n      settings: {\n        text: 'PrairieLearn',\n        placements: [\n          {\n            text: 'PrairieLearn',\n            enabled: true,\n            placement: 'course_navigation',\n            default: 'disabled',\n            message_type: 'LtiResourceLinkRequest',\n            target_link_uri: 'PLACEHOLDER--will be replaced later',\n            windowTarget: '_blank',\n          },\n        ],\n      },\n    },\n  ],\n  custom_fields: {},\n  public_jwk_url: 'PLACEHOLDER--will be replaced later',\n  scopes: [\n    'https://purl.imsglobal.org/spec/lti-ags/scope/lineitem',\n    'https://purl.imsglobal.org/spec/lti-ags/scope/score',\n    'https://purl.imsglobal.org/spec/lti-nrps/scope/contextmembership.readonly',\n  ],\n};\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    // This function is largely Canvas-specific. If different LMSes have different imports,\n    // we can extend this to look at the LTI 1.3 instance `platform` and respond accordingly.\n    //\n    // https://canvas.instructure.com/doc/api/file.lti_dev_key_config.html#anatomy-of-a-json-configuration\n    //\n    // The file is human readable on purpose to support manual configuration in the LMS.\n\n    const lti13_instance = await selectLti13Instance(req.params.lti13_instance_id);\n\n    const lmsConfig = structuredClone(ltiConfig);\n    const host = getCanonicalHost(req);\n    const url = new URL(host);\n\n    lmsConfig.oidc_initiation_url = `${host}/pl/lti13_instance/${lti13_instance.id}/auth/login`;\n    lmsConfig.target_link_uri = `${host}/pl/lti13_instance/${lti13_instance.id}/auth/callback`;\n\n    // Use URL to extract just the hostname\n    lmsConfig.extensions[0].domain = url.hostname || '';\n    lmsConfig.extensions[0].settings.placements[0].target_link_uri = `${host}/pl/lti13_instance/${lti13_instance.id}/course_navigation`;\n\n    lmsConfig.public_jwk_url = `${host}/pl/lti13_instance/${lti13_instance.id}/jwks`;\n    lmsConfig.custom_fields = lti13_instance.custom_fields;\n\n    res.setHeader('Content-Type', 'application/json');\n    res.end(JSON.stringify(lmsConfig, null, 2));\n  }),\n);\n\nexport default router;\n"]}