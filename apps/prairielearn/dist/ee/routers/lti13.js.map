{"version":3,"file":"lti13.js","sourceRoot":"","sources":["../../../src/ee/routers/lti13.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,MAAM,EAAE,MAAM,SAAS,CAAC;AACjC,OAAO,YAAY,MAAM,uBAAuB,CAAC;AAEjD,OAAO,KAAK,KAAK,MAAM,qBAAqB,CAAC;AAE7C,OAAO,EAAE,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AACvD,OAAO,eAAe,MAAM,4BAA4B,CAAC;AACzD,OAAO,SAAS,MAAM,gCAAgC,CAAC;AACvD,OAAO,SAAS,MAAM,4BAA4B,CAAC;AACnD,OAAO,EAAE,qCAAqC,EAAE,MAAM,uBAAuB,CAAC;AAC9E,OAAO,EAAE,mBAAmB,EAAE,MAAM,4BAA4B,CAAC;AACjE,OAAO,WAAW,MAAM,qCAAqC,CAAC;AAC9D,OAAO,qBAAqB,MAAM,yDAAyD,CAAC;AAC5F,OAAO,SAAS,MAAM,iCAAiC,CAAC;AAExD,MAAM,MAAM,GAAG,MAAM,CAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAC;AAE7C,MAAM,CAAC,GAAG,CACR,sBAAsB,EACtB,YAAY,CAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;IACpC,MAAM,cAAc,GAAG,MAAM,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC;IAC/E,IACE,MAAM,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE;QAC9B,cAAc,EAAE,cAAc,CAAC,cAAc;KAC9C,CAAC,EACF,CAAC;QACD,IAAI,EAAE,CAAC;IACT,CAAC;SAAM,CAAC;QACN,MAAM,IAAI,KAAK,CAAC,eAAe,CAAC,GAAG,EAAE,4CAA4C,CAAC,CAAC;IACrF,CAAC;AACH,CAAC,CAAC,CACH,CAAC;AAEF,MAAM,CAAC,GAAG,CAAC,4BAA4B,EAAE,WAAW,CAAC,CAAC;AACtD,MAAM,CAAC,GAAG,CAAC,0BAA0B,EAAE,SAAS,CAAC,CAAC;AAElD,wEAAwE;AACxE,MAAM,CAAC,GAAG,CACR,sBAAsB,EACtB,YAAY,CAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;IACpC,MAAM,cAAc,GAAG,MAAM,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC;IAC/E,MAAM,iBAAiB,GAAG,MAAM,qCAAqC,CACnE,cAAc,CAAC,cAAc,CAC9B,CAAC;IAEF,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,SAAS,CAAC,EAAE,CAAC;QACzD,MAAM,IAAI,KAAK,CAAC,yDAAyD,CAAC,CAAC;IAC7E,CAAC;IACD,IAAI,EAAE,CAAC;AACT,CAAC,CAAC,CACH,CAAC;AAEF,MAAM,CAAC,GAAG,CAAC,0BAA0B,EAAE,SAAS,CAAC,CAAC;AAClD,MAAM,CAAC,GAAG,CACR,uCAAuC,EACvC,eAAe,EAAE,4CAA4C;AAC7D,SAAS,EACT,qBAAqB,CACtB,CAAC;AAEF,eAAe,MAAM,CAAC","sourcesContent":["import { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport * as error from '@prairielearn/error';\n\nimport { features } from '../../lib/features/index.js';\nimport authnMiddleware from '../../middlewares/authn.js';\nimport csrfToken from '../../middlewares/csrfToken.js';\nimport lti13Auth from '../auth/lti13/lti13Auth.js';\nimport { getInstitutionAuthenticationProviders } from '../lib/institution.js';\nimport { selectLti13Instance } from '../models/lti13Instance.js';\nimport lti13Config from '../pages/lti13Config/lti13Config.js';\nimport lti13CourseNavigation from '../pages/lti13CourseNavigation/lti13CourseNavigation.js';\nimport lti13Jwks from '../pages/lti13Jwks/lti13Jwks.js';\n\nconst router = Router({ mergeParams: true });\n\nrouter.use(\n  '/:lti13_instance_id/',\n  asyncHandler(async (req, res, next) => {\n    const lti13_instance = await selectLti13Instance(req.params.lti13_instance_id);\n    if (\n      await features.enabled('lti13', {\n        institution_id: lti13_instance.institution_id,\n      })\n    ) {\n      next();\n    } else {\n      throw new error.HttpStatusError(403, 'Access denied. LTI 1.3 feature not enabled');\n    }\n  }),\n);\n\nrouter.use('/:lti13_instance_id/config', lti13Config);\nrouter.use('/:lti13_instance_id/jwks', lti13Jwks);\n\n// Everything past this middleware requires LTI 1.3 SSO to be configured\nrouter.use(\n  '/:lti13_instance_id/',\n  asyncHandler(async (req, res, next) => {\n    const lti13_instance = await selectLti13Instance(req.params.lti13_instance_id);\n    const instAuthProviders = await getInstitutionAuthenticationProviders(\n      lti13_instance.institution_id,\n    );\n\n    if (!instAuthProviders.some((a) => a.name === 'LTI 1.3')) {\n      throw new Error('Institution does not support LTI 1.3 SSO authentication');\n    }\n    next();\n  }),\n);\n\nrouter.use('/:lti13_instance_id/auth', lti13Auth);\nrouter.use(\n  '/:lti13_instance_id/course_navigation',\n  authnMiddleware, // authentication, set res.locals.authn_user\n  csrfToken,\n  lti13CourseNavigation,\n);\n\nexport default router;\n"]}