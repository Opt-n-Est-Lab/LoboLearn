{"version":3,"file":"ai-grading.js","sourceRoot":"","sources":["../../src/lib/ai-grading.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,OAAO,MAAM,SAAS,CAAC;AAEnC,OAAO,EAAE,sBAAsB,EAAE,MAAM,eAAe,CAAC;AAEvD;;;;GAIG;AACH,MAAM,CAAC,KAAK,UAAU,qBAAqB,CAAC,IAAY;IACtD,MAAM,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;IAE1C,mEAAmE;IACnE,CAAC,CAAC,QAAQ,CAAC,CAAC,MAAM,EAAE,CAAC;IACrB,CAAC,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE,CAAC;IACpB,CAAC,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,CAAC;IACnB,CAAC,CAAC,UAAU,CAAC,CAAC,MAAM,EAAE,CAAC;IACvB,CAAC,CAAC,KAAK,CAAC,CAAC,MAAM,EAAE,CAAC;IAElB,kDAAkD;IAClD,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,EAAE,EAAE;QACpB,IAAI,EAAE,CAAC,IAAI,KAAK,KAAK;YAAE,OAAO;QAE9B,uDAAuD;QACvD,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,MAAM,EAAE,CAAC;YACzC,CAAC,CAAC,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;YACf,OAAO;QACT,CAAC;QAED,CAAC,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACvB,CAAC,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QAC1B,CAAC,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QAC1B,KAAK,MAAM,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,CAAC;YAC3C,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;gBAChC,CAAC,CAAC,EAAE,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;YACzB,CAAC;QACH,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,iDAAiD;IACjD,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,EAAE,EAAE;QACpB,IAAI,EAAE,CAAC,IAAI,KAAK,KAAK;YAAE,OAAO;QAC9B,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC;YAC/B,CAAC,CAAC,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;QACjB,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,MAAM,MAAM,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC;IACxB,IAAI,MAAM,CAAC,MAAM,GAAG,KAAK,EAAE,CAAC;QAC1B,oEAAoE;QACpE,sEAAsE;QACtE,OAAO,IAAI,CAAC,IAAI,EAAE,CAAC;IACrB,CAAC;IAED,OAAO,CAAC,MAAM,sBAAsB,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;AACvD,CAAC","sourcesContent":["import * as cheerio from 'cheerio';\n\nimport { formatHtmlWithPrettier } from './prettier.js';\n\n/**\n * Processes rendered question HTML to make it suitable for AI grading.\n * This includes removing scripts/stylesheets and attributes that aren't\n * relevant to grading.\n */\nexport async function stripHtmlForAiGrading(html: string) {\n  const $ = cheerio.load(html, null, false);\n\n  // Remove elements that are guaranteed to be irrelevant to grading.\n  $('script').remove();\n  $('style').remove();\n  $('link').remove();\n  $('noscript').remove();\n  $('svg').remove();\n\n  // Filter out more irrelevant elements/attributes.\n  $('*').each((_, el) => {\n    if (el.type !== 'tag') return;\n\n    // Remove elements that are hidden from screen readers.\n    if ($(el).attr('aria-hidden') === 'true') {\n      $(el).remove();\n      return;\n    }\n\n    $(el).removeAttr('id');\n    $(el).removeAttr('class');\n    $(el).removeAttr('style');\n    for (const name of Object.keys(el.attribs)) {\n      if (name.startsWith('data-bs-')) {\n        $(el).removeAttr(name);\n      }\n    }\n  });\n\n  // Remove all elements that have no text content.\n  $('*').each((_, el) => {\n    if (el.type !== 'tag') return;\n    if ($(el).text().trim() === '') {\n      $(el).remove();\n    }\n  });\n\n  const result = $.html();\n  if (result.length > 10000) {\n    // Prevent denial of service attacks by skipping Prettier formatting\n    // if the HTML is too large. 10,000 characters was chosen arbitrarily.\n    return html.trim();\n  }\n\n  return (await formatHtmlWithPrettier(result)).trim();\n}\n"]}