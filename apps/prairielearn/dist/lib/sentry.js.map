{"version":3,"file":"sentry.js","sourceRoot":"","sources":["../../src/lib/sentry.ts"],"names":[],"mappings":"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","sourcesContent":["import type { NextFunction, Request, Response } from 'express';\n\nimport * as Sentry from '@prairielearn/sentry';\n\nexport function enrichSentryEventMiddleware(req: Request, res: Response, next: NextFunction) {\n  // This will ensure that this middleware is always run in an isolated\n  // context so that we don't accidentally leak data between requests.\n  Sentry.withIsolationScope((scope) => {\n    // This event processor will run whenever an event is captured by Sentry.\n    // It will use as much context as it can, but will gracefully handle the\n    // case where context is missing.\n    scope.addEventProcessor((event) => {\n      event.tags ??= {};\n\n      event.tags.response_id = res.locals.response_id;\n      event.tags.method = req.method;\n      event.tags.url = req.originalUrl;\n\n      if (res.locals.error_id) {\n        event.tags.error_id = res.locals.error_id;\n      }\n\n      if (res.locals.authn_user?.user_id) {\n        event.user = {\n          id: res.locals.authn_user.user_id.toString(),\n          // To comply with GDPR and other data protection laws, you can\n          // configure Sentry to not store IP addresses. Sentry will then\n          // only use the IP address to compute a country code and\n          // immediately discard it.\n          ip_address: req.ip,\n        };\n      }\n\n      if (res.locals?.course?.id) {\n        event.tags['course.id'] = res.locals.course?.id;\n        event.tags['course.short_name'] = res.locals.course?.short_name;\n        event.tags['course.title'] = res.locals.course?.title;\n      }\n\n      if (res.locals?.course_instance?.id) {\n        event.tags['course_instance.id'] = res.locals.course_instance?.id;\n        event.tags['course_instance.short_name'] = res.locals.course_instance?.short_name;\n        event.tags['course_instance.long_name'] = res.locals.course_instance?.long_name;\n      }\n\n      if (res.locals?.assessment?.id) {\n        event.tags['assessment.id'] = res.locals.assessment?.id;\n        event.tags['assessment.directory'] = res.locals.assessment?.directory;\n      }\n\n      if (res.locals?.assessment_instance?.id) {\n        event.tags['assessment_instance.id'] = res.locals.assessment_instance?.id;\n      }\n\n      if (res.locals?.question?.id) {\n        event.tags['question.id'] = res.locals.question?.id;\n        event.tags['question.directory'] = res.locals.question?.directory;\n      }\n\n      if (res.locals?.instance_question?.id) {\n        event.tags['instance_question.id'] = res.locals.instance_question?.id;\n      }\n\n      return event;\n    });\n\n    next();\n  });\n}\n"]}