{"version":3,"file":"server-jobs.js","sourceRoot":"","sources":["../../src/lib/server-jobs.ts"],"names":[],"mappings":"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","sourcesContent":["import { setTimeout as sleep } from 'node:timers/promises';\n\nimport { execa } from 'execa';\nimport * as shlex from 'shlex';\nimport { z } from 'zod';\n\nimport { logger } from '@prairielearn/logger';\nimport { loadSqlEquiv, queryAsync, queryRow, queryRows } from '@prairielearn/postgres';\nimport * as Sentry from '@prairielearn/sentry';\nimport { checkSignedToken, generateSignedToken } from '@prairielearn/signed-token';\n\nimport { ansiToHtml, chalk } from './chalk.js';\nimport { config } from './config.js';\nimport { IdSchema, type Job, JobSchema, JobSequenceSchema } from './db-types.js';\nimport { JobSequenceWithJobsSchema, type JobSequenceWithTokens } from './server-jobs.types.js';\nimport * as socketServer from './socket-server.js';\n\nconst sql = loadSqlEquiv(import.meta.url);\n\ninterface CreateServerJobOptions {\n  courseId?: string;\n  courseInstanceId?: string;\n  courseRequestId?: string;\n  assessmentId?: string;\n  userId?: string;\n  authnUserId?: string;\n  type: string;\n  description: string;\n}\n\ninterface ServerJobExecOptions {\n  cwd: string;\n  env?: NodeJS.ProcessEnv;\n}\n\nexport interface ServerJobResult {\n  data: Record<string, any>;\n}\n\nexport interface ServerJobLogger {\n  error(msg: string): void;\n  warn(msg: string): void;\n  info(msg: string): void;\n  verbose(msg: string): void;\n}\n\nexport interface ServerJob extends ServerJobLogger {\n  fail(msg: string): never;\n  exec(file: string, args?: string[], options?: ServerJobExecOptions): Promise<ServerJobResult>;\n  data: Record<string, unknown>;\n}\n\nexport interface ServerJobExecutor {\n  jobSequenceId: string;\n  execute(fn: ServerJobExecutionFunction): Promise<ServerJobResult>;\n  executeUnsafe(fn: ServerJobExecutionFunction): Promise<ServerJobResult>;\n  executeInBackground(fn: ServerJobExecutionFunction): void;\n}\n\nexport type ServerJobExecutionFunction = (job: ServerJob) => Promise<void>;\n\n/**\n * Store currently active job information in memory. This is used\n * to accumulate stderr/stdout, which are only written to the DB\n * once the job is finished.\n */\nexport const liveJobs: Record<string, ServerJobImpl> = {};\n\n/********************************************************************/\n\nlet heartbeatIntervalId: ReturnType<typeof setInterval> | null = null;\n\n/**\n * Internal error subclass so we can identify when `fail()` is called.\n */\nclass ServerJobAbortError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ServerJobAbortError';\n  }\n}\n\nclass ServerJobImpl implements ServerJob, ServerJobExecutor {\n  public jobSequenceId: string;\n  public jobId: string;\n  public data: Record<string, unknown> = {};\n  private started = false;\n  private finished = false;\n  public output = '';\n  private lastSent = Date.now();\n\n  constructor(jobSequenceId: string, jobId: string) {\n    this.jobSequenceId = jobSequenceId;\n    this.jobId = jobId;\n  }\n\n  fail(msg: string): never {\n    this.error(msg);\n    throw new ServerJobAbortError(msg);\n  }\n\n  error(msg: string) {\n    this.addToOutput(chalk.redBright(msg) + '\\n');\n  }\n\n  warn(msg: string) {\n    this.addToOutput(chalk.yellowBright(msg) + '\\n');\n  }\n\n  info(msg: string) {\n    this.addToOutput(msg + '\\n');\n  }\n\n  verbose(msg: string) {\n    this.addToOutput(chalk.dim(msg) + '\\n');\n  }\n\n  async exec(\n    file: string,\n    args: string[] = [],\n    options: ServerJobExecOptions,\n  ): Promise<ServerJobResult> {\n    this.addToOutput(chalk.blueBright(`Command: ${shlex.join([file, ...args])}\\n`));\n    this.addToOutput(chalk.blueBright(`Working directory: ${options.cwd}\\n`));\n\n    const start = performance.now();\n    let didOutput = false;\n    const proc2 = execa(file, args, {\n      ...options,\n      all: true,\n    });\n    proc2.all?.setEncoding('utf-8');\n    proc2.all?.on('data', (data) => {\n      didOutput = true;\n      this.addToOutput(data);\n    });\n\n    try {\n      await proc2;\n    } finally {\n      // Ensure we start a new line after all command output, but only if there\n      // was in fact any output from the command.\n      if (didOutput && !this.output.endsWith('\\n')) {\n        this.addToOutput('\\n');\n      }\n\n      // Record timing information.\n      const duration = (performance.now() - start).toFixed(2);\n      this.addToOutput(chalk.dim(`Command completed in ${duration}ms`) + '\\n\\n');\n    }\n\n    return { data: this.data };\n  }\n\n  /**\n   * Runs the job sequence and returns a Promise that resolves when the job\n   * sequence has completed, even if an error is encountered.\n   */\n  async execute(fn: ServerJobExecutionFunction): Promise<ServerJobResult> {\n    this.checkAndMarkStarted();\n    await this.executeInternal(fn, false);\n    return { data: this.data };\n  }\n\n  /**\n   * Runs the job sequence and returns a Promise that resolves when the job\n   * sequence has completed. The returned promise will reject if the job\n   * sequence fails.\n   */\n  async executeUnsafe(fn: ServerJobExecutionFunction): Promise<ServerJobResult> {\n    this.checkAndMarkStarted();\n    await this.executeInternal(fn, true);\n    return { data: this.data };\n  }\n\n  /**\n   * Identical to {@link execute}, except it doesn't return a Promise. This is\n   * just used as a hint to the caller that they don't need to wait for the job\n   * to finish. Useful for tools like TypeScript and ESLint that ensure that\n   * promises are awaited.\n   */\n  executeInBackground(fn: ServerJobExecutionFunction): void {\n    this.checkAndMarkStarted();\n    this.executeInternal(fn, false);\n  }\n\n  private checkAndMarkStarted() {\n    if (this.started) {\n      throw new Error('ServerJob already started');\n    }\n    this.started = true;\n  }\n\n  private async executeInternal(\n    fn: ServerJobExecutionFunction,\n    shouldThrow: boolean,\n  ): Promise<void> {\n    try {\n      await fn(this);\n      await this.finish();\n    } catch (err) {\n      try {\n        await this.finish(err);\n      } catch (err) {\n        logger.error(`Error failing job ${this.jobId}`, err);\n        Sentry.captureException(err);\n        if (shouldThrow) {\n          throw err;\n        }\n      }\n      if (shouldThrow) {\n        throw err;\n      }\n    }\n  }\n\n  private addToOutput(msg: string) {\n    this.output += msg;\n    this.flush();\n  }\n\n  private flush(force = false) {\n    if (Date.now() - this.lastSent > 1000 || force) {\n      const ansifiedOutput = ansiToHtml(this.output);\n      socketServer.io\n        ?.to('job-' + this.jobId)\n        .emit('change:output', { job_id: this.jobId, output: ansifiedOutput });\n      this.lastSent = Date.now();\n    }\n  }\n\n  private async finish(err: any = undefined) {\n    // Guard against handling job finish more than once.\n    if (this.finished) return;\n    this.finished = true;\n\n    // Force a send on the current output to ensure all messages are shown.\n    this.flush(true);\n\n    // A `ServerJobAbortError` is thrown by the `fail` method. We won't print\n    // any details about the error object itself, as `fail` will have already\n    // printed the message. This error is just used as a form of control flow.\n    if (err && !(err instanceof ServerJobAbortError)) {\n      // If the error has a stack, it will already include the stringified error.\n      // Otherwise, just use the stringified error.\n      if (err.stack) {\n        this.error(err.stack);\n      } else {\n        this.error(err.toString());\n      }\n\n      if (err.data) {\n        this.verbose('\\n' + JSON.stringify(err.data, null, 2));\n      }\n    }\n\n    delete liveJobs[this.jobId];\n\n    await queryAsync(sql.update_job_on_finish, {\n      job_sequence_id: this.jobSequenceId,\n      job_id: this.jobId,\n      output: this.output,\n      data: this.data,\n      status: err ? 'Error' : 'Success',\n    });\n\n    // Notify sockets.\n    socketServer.io?.to('job-' + this.jobId).emit('update');\n    socketServer.io?.to('jobSequence-' + this.jobSequenceId).emit('update');\n  }\n}\n\n/**\n * Creates a job sequence with a single job.\n */\nexport async function createServerJob(options: CreateServerJobOptions): Promise<ServerJobExecutor> {\n  const { job_sequence_id, job_id } = await queryRow(\n    sql.insert_job_sequence,\n    {\n      course_id: options.courseId,\n      course_instance_id: options.courseInstanceId,\n      course_request_id: options.courseRequestId,\n      assessment_id: options.assessmentId,\n      user_id: options.userId,\n      authn_user_id: options.authnUserId,\n      type: options.type,\n      description: options.description,\n    },\n    z.object({\n      job_sequence_id: z.string(),\n      job_id: z.string(),\n    }),\n  );\n\n  const serverJob = new ServerJobImpl(job_sequence_id, job_id);\n  liveJobs[job_id] = serverJob;\n  return serverJob;\n}\n\nexport async function selectJobsByJobSequenceId(jobSequenceId: string): Promise<Job[]> {\n  return await queryRows(sql.select_job_output, { job_sequence_id: jobSequenceId }, JobSchema);\n}\n\n/*\n  SocketIO configuration\n\n  ##########################################\n  Room 'job-231' for job_id = 231 in DB.\n\n  Receives messages:\n  'joinJob', arguments: job_id, returns: status, output\n\n  Sends messages:\n  'change:output', arguments: job_id, output\n  'update', arguments: job_id\n\n  ##########################################\n  Room 'jobSequence-593' for job_sequence_id = 593 in DB.\n\n  Receives messages:\n  'joinJobSequence', arguments: job_sequence_id, returns: job_count\n\n  Sends messages:\n  'update', arguments: job_sequence_id\n\n  ##########################################\n\n  'update' events are sent for bulk changes to the object when\n  there is no specific 'change' event available.\n\n  For example, an 'update' will not be sent when output changes\n  because the more specific 'change:output' event will be sent\n  instead.\n*/\n\nexport function init() {\n  socketServer.io.on('connection', connection);\n\n  // Start a periodic task to heartbeat all live jobs. We don't use a cronjob\n  // for this because we want this to run for every host.\n  heartbeatIntervalId = setInterval(() => {\n    const jobIds = Object.keys(liveJobs);\n    if (jobIds.length === 0) return;\n\n    queryAsync(sql.update_heartbeats, { job_ids: jobIds }).catch((err) => {\n      Sentry.captureException(err);\n      logger.error('Error updating heartbeats for live server jobs', err);\n    });\n  }, config.serverJobHeartbeatIntervalSec * 1000);\n}\n\nexport async function stop() {\n  // Wait until all jobs have finished.\n  while (Object.keys(liveJobs).length > 0) {\n    await sleep(100);\n  }\n\n  // Only once all jobs are finished should we stop sending heartbeats.\n  if (heartbeatIntervalId) {\n    clearInterval(heartbeatIntervalId);\n    heartbeatIntervalId = null;\n  }\n}\n\nexport function connection(socket) {\n  socket.on('joinJob', function (msg, callback) {\n    if (!('job_id' in msg)) {\n      logger.error('socket.io joinJob called without job_id');\n      return;\n    }\n\n    // Check authorization of the requester.\n    if (!checkSignedToken(msg.token, { jobId: msg.job_id.toString() }, config.secretKey)) {\n      logger.error(`joinJob called with invalid token for job_id ${msg.job_id}`);\n      return;\n    }\n\n    socket.join('job-' + msg.job_id);\n    queryRow(sql.select_job, { job_id: msg.job_id }, JobSchema).then(\n      (job) => {\n        const status = job.status;\n        const output = ansiToHtml(liveJobs[msg.job_id]?.output ?? job.output);\n        callback({ status, output });\n      },\n      (err) => {\n        Sentry.captureException(err);\n        logger.error('socket.io joinJob error selecting job_id ' + msg.job_id, err);\n      },\n    );\n  });\n\n  socket.on('joinJobSequence', function (msg, callback) {\n    if (!('job_sequence_id' in msg)) {\n      logger.error('socket.io joinJobSequence called without job_sequence_id');\n      return;\n    }\n\n    // Check authorization of the requester.\n    if (\n      !checkSignedToken(\n        msg.token,\n        { jobSequenceId: msg.job_sequence_id.toString() },\n        config.secretKey,\n      )\n    ) {\n      logger.error(\n        `joinJobSequence called with invalid token for job_sequence_id ${msg.job_sequence_id}`,\n      );\n      return;\n    }\n\n    socket.join('jobSequence-' + msg.job_id);\n    queryRow(\n      sql.select_job_sequence,\n      { job_sequence_id: msg.job_sequence_id },\n      JobSequenceSchema.extend({ job_count: z.coerce.number() }),\n    ).then(\n      ({ job_count }) => {\n        callback({ job_count });\n      },\n      (err) => {\n        Sentry.captureException(err);\n        logger.error(\n          'socket.io joinJobSequence error selecting job_sequence_id ' + msg.job_sequence_id,\n          err,\n        );\n      },\n    );\n  });\n}\n\nexport async function errorAbandonedJobs() {\n  const abandonedJobs = await queryRows(\n    sql.select_abandoned_jobs,\n    { timeout_secs: config.serverJobsAbandonedTimeoutSec },\n    z.object({ id: IdSchema, job_sequence_id: IdSchema.nullable() }),\n  );\n\n  for (const row of abandonedJobs) {\n    logger.debug('Job abandoned by server, id: ' + row.id);\n    try {\n      await queryAsync(sql.update_job_on_error, {\n        job_id: row.id,\n        output: null,\n        error_message: 'Job abandoned by server',\n      });\n    } catch (err) {\n      Sentry.captureException(err);\n      logger.error('errorAbandonedJobs: error updating job on error', err);\n    } finally {\n      socketServer.io.to('job-' + row.id).emit('update');\n      if (row.job_sequence_id != null) {\n        socketServer.io.to('jobSequence-' + row.job_sequence_id).emit('update');\n      }\n    }\n  }\n\n  const abandonedJobSequences = await queryRows(sql.error_abandoned_job_sequences, IdSchema);\n  abandonedJobSequences.forEach(function (job_sequence_id) {\n    socketServer.io.to('jobSequence-' + job_sequence_id).emit('update');\n  });\n}\n\nexport async function getJobSequence(\n  job_sequence_id: string,\n  course_id: string | null,\n): Promise<JobSequenceWithTokens> {\n  const jobSequence = await queryRow(\n    sql.select_job_sequence_with_course_id_as_json,\n    { job_sequence_id, course_id },\n    JobSequenceWithJobsSchema,\n  );\n\n  // Generate a token to authorize websocket requests for this job sequence.\n  const jobSequenceTokenData = { jobSequenceId: job_sequence_id.toString() };\n  return {\n    ...jobSequence,\n    token: generateSignedToken(jobSequenceTokenData, config.secretKey),\n    jobs: jobSequence.jobs.map((job) => {\n      // Also generate a token for each job.\n      const jobTokenData = { jobId: job.id.toString() };\n      return { ...job, token: generateSignedToken(jobTokenData, config.secretKey) };\n    }),\n  };\n}\n"]}