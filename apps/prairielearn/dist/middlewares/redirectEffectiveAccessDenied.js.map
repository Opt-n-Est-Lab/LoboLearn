{"version":3,"file":"redirectEffectiveAccessDenied.js","sourceRoot":"","sources":["../../src/middlewares/redirectEffectiveAccessDenied.ts"],"names":[],"mappings":"AAAA,OAAO,EAA4B,MAAM,SAAS,CAAC;AAEnD,OAAO,EAAE,QAAQ,EAAE,MAAM,cAAc,CAAC;AAExC,MAAM,6BAA6B,GAAwB,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;IACjF,+DAA+D;IAC/D,kEAAkE;IAClE,qDAAqD;IACrD,gEAAgE;IAChE,kEAAkE;IAElE,4CAA4C;IAC5C,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAEzC,qGAAqG;IACrG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,yBAAyB;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAE5D,kCAAkC;IAClC,IAAI,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,OAAO,IAAI,IAAI;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAC9D,IAAI,GAAG,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,IAAI,IAAI;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAExD,0EAA0E;IAC1E,IAAI,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,CAAC,OAAO,EAAE,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAEvF,sCAAsC;IACtC,IAAI,GAAG,CAAC,MAAM,CAAC,cAAc,IAAI,IAAI;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAExD,oDAAoD;IACpD,IACE,GAAG,CAAC,MAAM,EAAE,eAAe,EAAE,EAAE;QAC/B,CAAC,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,mCAAmC;YAC1D,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,6BAA6B,CAAC,EACxD,CAAC;QACD,GAAG,CAAC,QAAQ,CACV,GAAG,GAAG,CAAC,MAAM,CAAC,cAAc,oBAAoB,GAAG,CAAC,MAAM,CAAC,eAAe,CAAC,EAAE,aAAa,CAC3F,CAAC;QACF,OAAO;IACT,CAAC;IAED,2CAA2C;IAC3C,IAAI,GAAG,CAAC,MAAM,EAAE,MAAM,EAAE,EAAE,IAAI,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,6BAA6B,EAAE,CAAC;QACpF,GAAG,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,MAAM,CAAC,cAAc,WAAW,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC,CAAC;QAC5E,OAAO;IACT,CAAC;IAED,iDAAiD;IACjD,IAAI,GAAG,CAAC,MAAM,EAAE,eAAe,EAAE,EAAE,IAAI,GAAG,CAAC,MAAM,EAAE,UAAU,EAAE,kBAAkB,EAAE,CAAC;QAClF,GAAG,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,MAAM,CAAC,cAAc,oBAAoB,GAAG,CAAC,MAAM,CAAC,eAAe,CAAC,EAAE,EAAE,CAAC,CAAC;QAC9F,OAAO;IACT,CAAC;IAED,oDAAoD;IACpD,IAAI,CAAC,GAAG,CAAC,CAAC;AACZ,CAAC,CAAC;AAEF,eAAe,6BAA6B,CAAC","sourcesContent":["import { type ErrorRequestHandler } from 'express';\n\nimport { idsEqual } from '../lib/id.js';\n\nconst redirectEffectiveAccessDenied: ErrorRequestHandler = (err, req, res, next) => {\n  // This middleware tries to handle the case where an instructor\n  // starts emulating another effective user, but they are currently\n  // on a page to which the effective user doesn't have\n  // permission. This results in a 403 (Access Denied) error. Here\n  // we try and detect this case and redirect to an accessible page.\n\n  // we are only capturing 403 = Access Denied\n  if (err.status !== 403) return next(err);\n\n  // we only redirect if we tried to change emulation data (see middlewares/effectiveRequestChanged.js)\n  if (!res.locals.pl_requested_data_changed) return next(err);\n\n  // skip if we don't have user data\n  if (res.locals?.authn_user?.user_id == null) return next(err);\n  if (res.locals?.user?.user_id == null) return next(err);\n\n  // we are only interested in cases where we are emulating a different user\n  if (idsEqual(res.locals.authn_user.user_id, res.locals.user.user_id)) return next(err);\n\n  // check that we have a plainUrlPrefix\n  if (res.locals.plainUrlPrefix == null) return next(err);\n\n  // try to redirect to the instructor course instance\n  if (\n    res.locals?.course_instance?.id &&\n    (res.locals?.authz_data?.has_course_instance_permission_view ||\n      res.locals?.authz_data?.has_course_permission_preview)\n  ) {\n    res.redirect(\n      `${res.locals.plainUrlPrefix}/course_instance/${res.locals.course_instance.id}/instructor`,\n    );\n    return;\n  }\n\n  // try to redirect to the instructor course\n  if (res.locals?.course?.id && res.locals?.authz_data?.has_course_permission_preview) {\n    res.redirect(`${res.locals.plainUrlPrefix}/course/${res.locals.course.id}`);\n    return;\n  }\n\n  // try to redirect to the student course instance\n  if (res.locals?.course_instance?.id && res.locals?.authz_data?.has_student_access) {\n    res.redirect(`${res.locals.plainUrlPrefix}/course_instance/${res.locals.course_instance.id}`);\n    return;\n  }\n\n  // give up, we couldn't figure out a useful redirect\n  next(err);\n};\n\nexport default redirectEffectiveAccessDenied;\n"]}