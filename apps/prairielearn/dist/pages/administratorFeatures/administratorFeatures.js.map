{"version":3,"file":"administratorFeatures.js","sourceRoot":"","sources":["../../../src/pages/administratorFeatures/administratorFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { loadSqlEquiv, queryAsync, queryRows } from '@prairielearn/postgres';\n\nimport { config } from '../../lib/config.js';\nimport {\n  CourseInstanceSchema,\n  CourseSchema,\n  IdSchema,\n  InstitutionSchema,\n  type User,\n} from '../../lib/db-types.js';\nimport { type FeatureName, features } from '../../lib/features/index.js';\nimport { selectOptionalUserByUid } from '../../models/user.js';\n\nimport {\n  AddFeatureGrantModalBody,\n  AdministratorFeature,\n  AdministratorFeatures,\n  FeatureGrantRowSchema,\n} from './administratorFeatures.html.js';\n\nconst router = Router();\nconst sql = loadSqlEquiv(import.meta.url);\n\nfunction validateFeature(feature: string): FeatureName {\n  if (!features.hasFeature(feature)) {\n    throw new error.HttpStatusError(404, `Unknown feature: ${feature}`);\n  }\n  return feature;\n}\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    res.send(\n      AdministratorFeatures({\n        features: features.allFeatures().sort(),\n        resLocals: res.locals,\n      }),\n    );\n  }),\n);\n\nrouter.get(\n  '/:feature',\n  asyncHandler(async (req, res) => {\n    const feature = validateFeature(req.params.feature);\n\n    const featureGrants = await queryRows(\n      sql.select_feature_grants,\n      { name: feature },\n      FeatureGrantRowSchema,\n    );\n    const institutions = await queryRows(sql.select_institutions, {}, InstitutionSchema);\n\n    res.send(\n      AdministratorFeature({\n        feature: req.params.feature,\n        featureGrants,\n        institutions,\n        featureInConfig: config.features[req.params.feature] ?? null,\n        resLocals: res.locals,\n      }),\n    );\n  }),\n);\n\nconst OptionalIdSchema = z\n  .union([z.literal(''), IdSchema])\n  .optional()\n  .transform((val) => val || undefined);\n\nconst AddFeatureGrantModalParamsSchema = z.object({\n  enabled: z.union([z.literal('true'), z.literal('false')]).transform((val) => val === 'true'),\n  institution_id: OptionalIdSchema,\n  course_id: OptionalIdSchema,\n  course_instance_id: OptionalIdSchema,\n  user_uid: z\n    .string()\n    .optional()\n    .transform((val) => val?.trim()),\n});\ntype AddFeatureGrantModalParams = z.infer<typeof AddFeatureGrantModalParamsSchema>;\n\nasync function getEntitiesFromParams(params: AddFeatureGrantModalParams) {\n  const institutions = await queryRows(sql.select_institutions, {}, InstitutionSchema);\n  const courses = params.institution_id\n    ? await queryRows(\n        sql.select_courses_for_institution,\n        { institution_id: params.institution_id },\n        CourseSchema,\n      )\n    : [];\n  const course_instances = params.course_id\n    ? await queryRows(\n        sql.select_course_instances_for_course,\n        { course_id: params.course_id },\n        CourseInstanceSchema,\n      )\n    : [];\n\n  const institution = institutions.find((inst) => inst.id === params.institution_id);\n  let course = courses.find((course) => course.id === params.course_id);\n  let course_instance = course_instances.find((ci) => ci.id === params.course_instance_id);\n\n  // Ensure consistency: if a selected entity isn't present in the parent,\n  // reset it to null.\n  const institutionHasCourse = courses.some((course) => course.id === params.course_id);\n  const courseHasCourseInstance = course_instances.some(\n    (ci) => ci.id === params.course_instance_id,\n  );\n\n  if (!institutionHasCourse) {\n    course = undefined;\n    course_instance = undefined;\n  }\n\n  if (!institutionHasCourse || !courseHasCourseInstance) {\n    course_instance = undefined;\n  }\n\n  let user: User | null = null;\n  if (params.user_uid) {\n    user = await selectOptionalUserByUid(params.user_uid);\n    if (!user) {\n      throw new error.HttpStatusError(400, `User not found: ${params.user_uid}`);\n    }\n  }\n\n  return { institutions, institution, courses, course, course_instances, course_instance, user };\n}\n\nrouter.get(\n  '/:feature/modal',\n  asyncHandler(async (req, res) => {\n    const feature = validateFeature(req.params.feature);\n\n    const query = AddFeatureGrantModalParamsSchema.parse(req.query);\n    const { institutions, institution, courses, course, course_instances, course_instance } =\n      await getEntitiesFromParams(query);\n\n    res.send(\n      AddFeatureGrantModalBody({\n        feature,\n        enabled: query.enabled,\n        institutions,\n        institution_id: institution?.id,\n        courses,\n        course_id: course?.id,\n        course_instances,\n        course_instance_id: course_instance?.id,\n      }).toString(),\n    );\n  }),\n);\n\nrouter.post(\n  '/:feature',\n  asyncHandler(async (req, res) => {\n    if (req.body.__action === 'add_feature_grant') {\n      const feature = validateFeature(req.params.feature);\n\n      const params = AddFeatureGrantModalParamsSchema.parse(req.body);\n      const { institution, course, course_instance, user } = await getEntitiesFromParams(params);\n\n      const context = features.validateContext({\n        institution_id: institution?.id ?? null,\n        course_id: course?.id ?? null,\n        course_instance_id: course_instance?.id ?? null,\n        user_id: user?.user_id ?? null,\n      });\n\n      if (params.enabled) {\n        await features.enable(feature, context);\n      } else {\n        await features.disable(feature, context);\n      }\n\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'update_feature_grant_enabled') {\n      const enabled = z\n        .union([z.literal('enabled'), z.literal('disabled')])\n        .transform((val) => val === 'enabled')\n        .parse(req.body.feature_grant_enabled);\n\n      await queryAsync(sql.update_feature_grant_enabled, {\n        id: IdSchema.parse(req.body.feature_grant_id),\n        enabled,\n      });\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'revoke_feature_grant') {\n      await queryAsync(sql.delete_feature_grant, { id: IdSchema.parse(req.body.feature_grant_id) });\n      res.redirect(req.originalUrl);\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}