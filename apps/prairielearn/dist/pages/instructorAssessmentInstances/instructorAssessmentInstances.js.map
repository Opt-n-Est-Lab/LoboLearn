{"version":3,"file":"instructorAssessmentInstances.js","sourceRoot":"","sources":["../../../src/pages/instructorAssessmentInstances/instructorAssessmentInstances.ts"],"names":[],"mappings":"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","sourcesContent":["import { Temporal } from '@js-temporal/polyfill';\nimport * as express from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport * as error from '@prairielearn/error';\nimport * as sqldb from '@prairielearn/postgres';\n\nimport {\n  checkBelongs,\n  deleteAllAssessmentInstancesForAssessment,\n  deleteAssessmentInstance,\n  gradeAllAssessmentInstances,\n  gradeAssessmentInstance,\n} from '../../lib/assessment.js';\nimport { regradeAssessmentInstance } from '../../lib/regrading.js';\n\nimport { InstructorAssessmentInstances } from './instructorAssessmentInstances.html.js';\nimport { AssessmentInstanceRowSchema } from './instructorAssessmentInstances.types.js';\n\nconst router = express.Router();\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\nrouter.get(\n  '/raw_data.json',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_instance_permission_view) {\n      throw new error.HttpStatusError(403, 'Access denied (must be a student data viewer)');\n    }\n    const assessmentInstances = await sqldb.queryRows(\n      sql.select_assessment_instances,\n      {\n        assessment_id: res.locals.assessment.id,\n      },\n      AssessmentInstanceRowSchema,\n    );\n    res.send(assessmentInstances);\n  }),\n);\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_instance_permission_view) {\n      throw new error.HttpStatusError(403, 'Access denied (must be a student data viewer)');\n    }\n    res.send(InstructorAssessmentInstances({ resLocals: res.locals }));\n  }),\n);\n\nrouter.post(\n  '/',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_instance_permission_edit) {\n      throw new error.HttpStatusError(403, 'Access denied (must be a student data editor)');\n    }\n\n    if (req.body.__action === 'close') {\n      const assessment_id = res.locals.assessment.id;\n      const assessment_instance_id = req.body.assessment_instance_id;\n      await checkBelongs(assessment_instance_id, assessment_id);\n      const requireOpen = true;\n      const close = true;\n      const overrideGradeRate = true;\n      await gradeAssessmentInstance(\n        assessment_instance_id,\n        res.locals.user.user_id,\n        res.locals.authn_user.user_id,\n        requireOpen,\n        close,\n        overrideGradeRate,\n        null, // client_fingerprint_id\n      );\n      res.send(JSON.stringify({}));\n    } else if (req.body.__action === 'delete') {\n      const assessment_id = res.locals.assessment.id;\n      const assessment_instance_id = req.body.assessment_instance_id;\n      await deleteAssessmentInstance(\n        assessment_id,\n        assessment_instance_id,\n        res.locals.authn_user.user_id,\n      );\n      res.send(JSON.stringify({}));\n    } else if (req.body.__action === 'grade_all' || req.body.__action === 'close_all') {\n      const assessment_id = res.locals.assessment.id;\n      const close = req.body.__action === 'close_all';\n      const overrideGradeRate = true;\n      const job_sequence_id = await gradeAllAssessmentInstances(\n        assessment_id,\n        res.locals.user.user_id,\n        res.locals.authn_user.user_id,\n        close,\n        overrideGradeRate,\n      );\n      res.redirect(res.locals.urlPrefix + '/jobSequence/' + job_sequence_id);\n    } else if (req.body.__action === 'delete_all') {\n      await deleteAllAssessmentInstancesForAssessment(\n        res.locals.assessment.id,\n        res.locals.authn_user.user_id,\n      );\n      res.send(JSON.stringify({}));\n    } else if (req.body.__action === 'regrade') {\n      const assessment_id = res.locals.assessment.id;\n      const assessment_instance_id = req.body.assessment_instance_id;\n      await checkBelongs(assessment_instance_id, assessment_id);\n      const job_sequence_id = await regradeAssessmentInstance(\n        assessment_instance_id,\n        res.locals.user.user_id,\n        res.locals.authn_user.user_id,\n      );\n      res.redirect(res.locals.urlPrefix + '/jobSequence/' + job_sequence_id);\n    } else if (req.body.__action === 'set_time_limit') {\n      const params = {\n        assessment_instance_id: req.body.assessment_instance_id,\n        assessment_id: res.locals.assessment.id,\n        time_add: req.body.time_add,\n        base_time: 'date_limit',\n        authn_user_id: res.locals.authz_data.authn_user.user_id,\n        exact_date: new Date(),\n      };\n      if (req.body.action === 'unlimited' || req.body.reopen_without_limit === 'true') {\n        params.base_time = 'null';\n      } else if (req.body.action === 'expire') {\n        params.base_time = 'current_date';\n        params.time_add = 0;\n      } else if (req.body.action === 'set_total') {\n        params.base_time = 'start_date';\n      } else if (req.body.action === 'set_rem') {\n        params.base_time = 'current_date';\n      } else if (req.body.action === 'set_exact') {\n        params.base_time = 'exact_date';\n        params.time_add = 0;\n        params.exact_date = new Date(\n          Temporal.PlainDateTime.from(req.body.date).toZonedDateTime(\n            res.locals.course_instance.display_timezone,\n          ).epochMilliseconds,\n        );\n      } else if (req.body.action === 'subtract') {\n        params.time_add *= -1;\n      }\n      await sqldb.queryAsync(sql.set_time_limit, params);\n      res.send(JSON.stringify({}));\n    } else if (req.body.__action === 'set_time_limit_all') {\n      const params = {\n        assessment_id: res.locals.assessment.id,\n        time_add: req.body.time_add,\n        base_time: 'date_limit',\n        reopen_closed: !!req.body.reopen_closed,\n        authn_user_id: res.locals.authz_data.authn_user.user_id,\n        exact_date: new Date(),\n      };\n      if (req.body.action === 'unlimited') {\n        params.base_time = 'null';\n      } else if (req.body.action === 'expire') {\n        params.base_time = 'current_date';\n        params.time_add = 0;\n      } else if (req.body.action === 'set_total') {\n        params.base_time = 'start_date';\n      } else if (req.body.action === 'set_rem') {\n        params.base_time = 'current_date';\n      } else if (req.body.action === 'set_exact') {\n        params.base_time = 'exact_date';\n        params.time_add = 0;\n        params.exact_date = new Date(\n          Temporal.PlainDateTime.from(req.body.date).toZonedDateTime(\n            res.locals.course_instance.display_timezone,\n          ).epochMilliseconds,\n        );\n      } else if (req.body.action === 'subtract') {\n        params.time_add *= -1;\n      }\n      await sqldb.queryAsync(sql.set_time_limit_all, params);\n      res.send(JSON.stringify({}));\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}