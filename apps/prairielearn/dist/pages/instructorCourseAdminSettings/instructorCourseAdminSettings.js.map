{"version":3,"file":"instructorCourseAdminSettings.js","sourceRoot":"","sources":["../../../src/pages/instructorCourseAdminSettings/instructorCourseAdminSettings.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\n\nimport sha256 from 'crypto-js/sha256.js';\nimport * as express from 'express';\nimport asyncHandler from 'express-async-handler';\nimport fs from 'fs-extra';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\n\nimport { b64EncodeUnicode } from '../../lib/base64-util.js';\nimport { CourseInfoCreateEditor, FileModifyEditor } from '../../lib/editors.js';\nimport { getPaths } from '../../lib/instructorFiles.js';\nimport { getCanonicalTimezones } from '../../lib/timezones.js';\nimport { updateCourseShowGettingStarted } from '../../models/course.js';\n\nimport { InstructorCourseAdminSettings } from './instructorCourseAdminSettings.html.js';\n\nconst router = express.Router();\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    const coursePathExists = await fs.pathExists(res.locals.course.path);\n    const courseInfoExists = await fs.pathExists(\n      path.join(res.locals.course.path, 'infoCourse.json'),\n    );\n    const availableTimezones = await getCanonicalTimezones([res.locals.course.display_timezone]);\n\n    let origHash = '';\n    if (courseInfoExists) {\n      origHash = sha256(\n        b64EncodeUnicode(\n          await fs.readFile(path.join(res.locals.course.path, 'infoCourse.json'), 'utf8'),\n        ),\n      ).toString();\n    }\n\n    res.send(\n      InstructorCourseAdminSettings({\n        resLocals: res.locals,\n        coursePathExists,\n        courseInfoExists,\n        availableTimezones,\n        origHash,\n      }),\n    );\n  }),\n);\n\nrouter.post(\n  '/',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_permission_edit) {\n      throw new error.HttpStatusError(403, 'Access denied (must be course editor)');\n    }\n\n    if (res.locals.course.example_course) {\n      throw new error.HttpStatusError(403, 'Access denied. Cannot make changes to example course.');\n    }\n\n    if (req.body.__action === 'update_configuration') {\n      if (!(await fs.pathExists(path.join(res.locals.course.path, 'infoCourse.json')))) {\n        throw new error.HttpStatusError(400, 'infoCourse.json does not exist');\n      }\n\n      const show_getting_started = req.body.show_getting_started === 'on';\n\n      if (res.locals.course.show_getting_started !== show_getting_started) {\n        await updateCourseShowGettingStarted({\n          course_id: res.locals.course.id,\n          show_getting_started,\n        });\n      }\n\n      const paths = getPaths(undefined, res.locals);\n\n      const courseInfo = JSON.parse(\n        await fs.readFile(path.join(res.locals.course.path, 'infoCourse.json'), 'utf8'),\n      );\n\n      const origHash = req.body.orig_hash;\n\n      const courseInfoEdit = courseInfo;\n      courseInfoEdit.name = req.body.short_name;\n      courseInfoEdit.title = req.body.title;\n      courseInfoEdit.timezone = req.body.display_timezone;\n\n      const editor = new FileModifyEditor({\n        locals: res.locals as any,\n        container: {\n          rootPath: paths.rootPath,\n          invalidRootPaths: paths.invalidRootPaths,\n        },\n        filePath: path.join(res.locals.course.path, 'infoCourse.json'),\n        editContents: b64EncodeUnicode(JSON.stringify(courseInfoEdit, null, 2)),\n        origHash,\n      });\n\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n      flash('success', 'Course configuration updated successfully');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'add_configuration') {\n      const infoJson = {\n        uuid: uuidv4(),\n        name: path.basename(res.locals.course.path),\n        title: path.basename(res.locals.course.path),\n        timezone: res.locals.institution.display_timezone,\n        options: {\n          useNewQuestionRenderer: true,\n        },\n        tags: [],\n        topics: [],\n      };\n      const editor = new CourseInfoCreateEditor({\n        locals: res.locals as any,\n        infoJson,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n        return res.redirect(req.originalUrl);\n      } catch {\n        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}