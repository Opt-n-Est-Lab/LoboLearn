{"version":3,"file":"instructorEffectiveUser.js","sourceRoot":"","sources":["../../../src/pages/instructorEffectiveUser/instructorEffectiveUser.ts"],"names":[],"mappings":"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","sourcesContent":["import { isValid, parseISO } from 'date-fns';\nimport { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport { HttpStatusError } from '@prairielearn/error';\nimport { loadSqlEquiv, queryRow } from '@prairielearn/postgres';\n\nimport { clearCookie, setCookie } from '../../lib/cookie.js';\n\nimport { CourseRolesSchema, InstructorEffectiveUser } from './instructorEffectiveUser.html.js';\n\nconst router = Router();\nconst sql = loadSqlEquiv(import.meta.url);\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    if (\n      !(\n        res.locals.authz_data.authn_has_course_permission_preview ||\n        res.locals.authz_data.authn_has_course_instance_permission_view\n      )\n    ) {\n      throw new HttpStatusError(\n        403,\n        'Access denied (must be course previewer or student data viewer)',\n      );\n    }\n\n    const courseRoles = await queryRow(\n      sql.select,\n      {\n        course_id: res.locals.course.id,\n        authn_course_role: res.locals.authz_data.authn_course_role,\n        authn_course_instance_role: res.locals.authz_data.authn_course_instance_role || 'None',\n      },\n      CourseRolesSchema,\n    );\n\n    let ipAddress = req.ip;\n    // Trim out IPv6 wrapper on IPv4 addresses\n    if (ipAddress.substring(0, 7) === '::ffff:') {\n      ipAddress = ipAddress.substring(7);\n    }\n\n    res.send(InstructorEffectiveUser({ resLocals: res.locals, ipAddress, courseRoles }));\n  }),\n);\n\nrouter.post(\n  '/',\n  asyncHandler(async (req, res) => {\n    if (\n      !(\n        res.locals.authz_data.authn_has_course_permission_preview ||\n        res.locals.authz_data.authn_has_course_instance_permission_view\n      )\n    ) {\n      throw new HttpStatusError(\n        403,\n        'Access denied (must be course previewer or student data viewer)',\n      );\n    }\n\n    if (req.body.__action === 'reset') {\n      clearCookie(res, ['pl_requested_uid', 'pl2_requested_uid']);\n      clearCookie(res, ['pl_requested_course_role', 'pl2_requested_course_role']);\n      clearCookie(res, ['pl_requested_course_instance_role', 'pl2_requested_course_instance_role']);\n      clearCookie(res, ['pl_requested_date', 'pl2_requested_date']);\n      setCookie(res, ['pl_requested_data_changed', 'pl2_requested_data_changed'], 'true');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'changeUid') {\n      setCookie(res, ['pl_requested_uid', 'pl2_requested_uid'], req.body.pl_requested_uid, {\n        maxAge: 60 * 60 * 1000,\n      });\n      setCookie(res, ['pl_requested_data_changed', 'pl2_requested_data_changed'], 'true');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'changeCourseRole') {\n      setCookie(\n        res,\n        ['pl_requested_course_role', 'pl2_requested_course_role'],\n        req.body.pl_requested_course_role,\n        { maxAge: 60 * 60 * 1000 },\n      );\n      setCookie(res, ['pl_requested_data_changed', 'pl2_requested_data_changed'], 'true');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'changeCourseInstanceRole') {\n      setCookie(\n        res,\n        ['pl_requested_course_instance_role', 'pl2_requested_course_instance_role'],\n        req.body.pl_requested_course_instance_role,\n        { maxAge: 60 * 60 * 1000 },\n      );\n      setCookie(res, ['pl_requested_data_changed', 'pl2_requested_data_changed'], 'true');\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'changeDate') {\n      const date = parseISO(req.body.pl_requested_date);\n      if (!isValid(date)) {\n        throw new HttpStatusError(400, `invalid requested date: ${req.body.pl_requested_date}`);\n      }\n      setCookie(res, ['pl_requested_date', 'pl2_requested_date'], date.toISOString(), {\n        maxAge: 60 * 60 * 1000,\n      });\n      setCookie(res, ['pl_requested_data_changed', 'pl2_requested_data_changed'], 'true');\n      res.redirect(req.originalUrl);\n    } else {\n      throw new HttpStatusError(400, 'unknown action: ' + res.locals.__action);\n    }\n  }),\n);\n\nexport default router;\n"]}