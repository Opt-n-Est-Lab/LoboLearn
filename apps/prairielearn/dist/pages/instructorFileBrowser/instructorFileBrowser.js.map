{"version":3,"file":"instructorFileBrowser.js","sourceRoot":"","sources":["../../../src/pages/instructorFileBrowser/instructorFileBrowser.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'node:path';\n\nimport { Router } from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport * as error from '@prairielearn/error';\n\nimport { createFileBrowser } from '../../components/FileBrowser.html.js';\nimport { InsufficientCoursePermissionsCardPage } from '../../components/InsufficientCoursePermissionsCard.js';\nimport { getCourseOwners } from '../../lib/course.js';\nimport { FileDeleteEditor, FileRenameEditor, FileUploadEditor } from '../../lib/editors.js';\nimport { getPaths } from '../../lib/instructorFiles.js';\nimport { encodePath } from '../../lib/uri-util.js';\n\nconst router = Router();\n\nrouter.get(\n  '/*',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_permission_view) {\n      // Access denied, but instead of sending them to an error page, we'll show\n      // them an explanatory message and prompt them to get view permissions.\n      const courseOwners = await getCourseOwners(res.locals.course.id);\n      res.status(403).send(\n        InsufficientCoursePermissionsCardPage({\n          resLocals: res.locals,\n          courseOwners,\n          pageTitle: 'Files',\n          requiredPermissions: 'Viewer',\n        }),\n      );\n      return;\n    }\n\n    const paths = getPaths(req.params[0], res.locals);\n\n    try {\n      const fileBrowser = await createFileBrowser({\n        paths,\n        resLocals: res.locals,\n        isReadOnly: false,\n      });\n      res.send(fileBrowser);\n    } catch (err) {\n      if (err.code === 'ENOENT' && paths.branch.length > 1) {\n        res.redirect(`${req.baseUrl}/${encodePath(paths.branch.slice(-2)[0].path)}`);\n        return;\n      }\n\n      throw err;\n    }\n  }),\n);\n\nrouter.post(\n  '/*',\n  asyncHandler(async (req, res) => {\n    if (!res.locals.authz_data.has_course_permission_edit) {\n      throw new error.HttpStatusError(403, 'Access denied (must be a course Editor)');\n    }\n\n    const paths = getPaths(req.params[0], res.locals);\n    const container = {\n      rootPath: paths.rootPath,\n      invalidRootPaths: paths.invalidRootPaths,\n    };\n\n    // NOTE: All actions are meant to do things to *files* and not to directories\n    // (or anything else). However, nowhere do we check that it is actually being\n    // applied to a file and not to a directory.\n\n    if (req.body.__action === 'delete_file') {\n      let deletePath: string;\n      try {\n        deletePath = path.join(res.locals.course.path, req.body.file_path);\n      } catch {\n        throw new Error(`Invalid file path: ${req.body.file_path}`);\n      }\n      const editor = new FileDeleteEditor({\n        locals: res.locals as any as any,\n        container,\n        deletePath,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n        return;\n      }\n      res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'rename_file') {\n      let oldPath: string;\n      try {\n        oldPath = path.join(req.body.working_path, req.body.old_file_name);\n      } catch {\n        throw new Error(\n          `Invalid old file path: ${req.body.working_path} / ${req.body.old_file_name}`,\n        );\n      }\n      if (!req.body.new_file_name) {\n        throw new Error(`Invalid new file name (was falsy): ${req.body.new_file_name}`);\n      }\n      if (\n        !/^(?:[-A-Za-z0-9_]+|\\.\\.)(?:\\/(?:[-A-Za-z0-9_]+|\\.\\.))*(?:\\.[-A-Za-z0-9_]+)?$/.test(\n          req.body.new_file_name,\n        )\n      ) {\n        throw new Error(\n          `Invalid new file name (did not match required pattern): ${req.body.new_file_name}`,\n        );\n      }\n      let newPath: string;\n      try {\n        newPath = path.join(req.body.working_path, req.body.new_file_name);\n      } catch {\n        throw new Error(\n          `Invalid new file path: ${req.body.working_path} / ${req.body.new_file_name}`,\n        );\n      }\n\n      if (oldPath === newPath) {\n        // The new file name is the same as old file name; do nothing.\n        res.redirect(req.originalUrl);\n        return;\n      }\n\n      const editor = new FileRenameEditor({\n        locals: res.locals as any,\n        container,\n        oldPath,\n        newPath,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        res.redirect(`${res.locals.urlPrefix}/edit_error/${serverJob.jobSequenceId}`);\n        return;\n      }\n      if (req.body.was_viewing_file) {\n        res.redirect(\n          `${res.locals.urlPrefix}/${res.locals.navPage}/file_view/${encodePath(\n            path.relative(res.locals.course.path, newPath),\n          )}`,\n        );\n      } else {\n        res.redirect(req.originalUrl);\n      }\n    } else if (req.body.__action === 'upload_file') {\n      if (!req.file) throw new Error('No file uploaded');\n\n      let filePath: string;\n      if (req.body.file_path) {\n        try {\n          filePath = path.join(res.locals.course.path, req.body.file_path);\n        } catch {\n          throw new Error(`Invalid file path: ${req.body.file_path}`);\n        }\n      } else {\n        try {\n          filePath = path.join(req.body.working_path, req.file.originalname);\n        } catch {\n          throw new Error(`Invalid file path: ${req.body.working_path} / ${req.file.originalname}`);\n        }\n      }\n      const editor = new FileUploadEditor({\n        locals: res.locals as any,\n        container,\n        filePath,\n        fileContents: req.file.buffer,\n      });\n\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        res.redirect(`${res.locals.urlPrefix}/edit_error/${serverJob.jobSequenceId}`);\n        return;\n      }\n      res.redirect(req.originalUrl);\n    } else {\n      throw new Error(`unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nexport default router;\n"]}