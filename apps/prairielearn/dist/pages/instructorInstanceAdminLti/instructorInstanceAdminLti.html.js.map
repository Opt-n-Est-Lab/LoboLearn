{"version":3,"file":"instructorInstanceAdminLti.html.js","sourceRoot":"","sources":["../../../src/pages/instructorInstanceAdminLti/instructorInstanceAdminLti.html.ts"],"names":[],"mappings":"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","sourcesContent":["import { escapeHtml, html } from '@prairielearn/html';\n\nimport { PageLayout } from '../../components/PageLayout.html.js';\nimport { CourseInstanceSyncErrorsAndWarnings } from '../../components/SyncErrorsAndWarnings.html.js';\nimport { config } from '../../lib/config.js';\nimport type { LtiCredentials, User } from '../../lib/db-types.js';\nimport { idsEqual } from '../../lib/id.js';\n\nexport function InstructorInstanceAdminLti({ resLocals }: { resLocals: Record<string, any> }) {\n  const {\n    authz_data,\n    course_owners,\n    lti_credentials,\n    __csrf_token: csrfToken,\n    lti_links,\n    assessments,\n    course_instance: courseInstance,\n    course,\n    urlPrefix,\n  } = resLocals;\n\n  return PageLayout({\n    resLocals,\n    pageTitle: 'LTI',\n    navContext: {\n      type: 'instructor',\n      page: 'instance_admin',\n      subPage: 'lti',\n    },\n    options: {\n      fullWidth: true,\n    },\n    preContent: html`\n      <script>\n        function copyToClipboard(element) {\n          var $temp = $('<input>');\n          $('body').append($temp);\n          $temp.val($(element).text()).select();\n          document.execCommand('copy');\n          $temp.remove();\n        }\n      </script>\n    `,\n    content: html`\n      ${CourseInstanceSyncErrorsAndWarnings({ authz_data, courseInstance, course, urlPrefix })}\n      ${!authz_data.has_course_permission_edit\n        ? html`\n            <div class=\"card mb-4\">\n              <div class=\"card-header bg-danger text-white\">\n                <h1>LTI configuration</h1>\n              </div>\n              <div class=\"card-body\">\n                <h2>Insufficient permissions</h2>\n                <p>You must have at least &quot;Editor&quot; permissions for this course.</p>\n                ${course_owners.length > 0\n                  ? html`\n                      <p>Contact one of the below course owners to request access.</p>\n                      <ul>\n                        ${course_owners.map(\n                          (owner: User) => html`\n                            <li>${owner.uid} ${owner.name ? `(${owner.name})` : ''}</li>\n                          `,\n                        )}\n                      </ul>\n                    `\n                  : ''}\n              </div>\n            </div>\n          `\n        : html`\n            <div class=\"card mb-4\">\n              <div class=\"card-header bg-primary text-white\">\n                <h1>LTI configuration</h1>\n              </div>\n              <div class=\"card-body\">\n                <p>\n                  The LTI (Learning Tools Interoperability) standard allows other online learning\n                  websites to embed PrairieLearn assessments within them. PrairieLearn acts as a\n                  <em>Tool Provider</em> for LTI. See the\n                  <a href=\"https://www.imsglobal.org/basic-overview-how-lti-works\">\n                    LTI overview\n                  </a>\n                  for more information.\n                </p>\n                <p>\n                  <strong>\n                    This version of LTI is deprecated. Check with PrairieLearn admins before\n                    enabling to ensure it is appropriate for your course.\n                  </strong>\n                </p>\n                ${!config.hasLti ? html`<p><em>LTI not enabled on this server.</em></p>` : ''}\n              </div>\n            </div>\n\n            ${config.hasLti\n              ? html`\n                  ${LtiCredentialsCard({ lti_credentials, csrfToken })}\n                  ${LtiLinkTargetsCard({ lti_links, assessments, csrfToken })}\n                `\n              : ''}\n          `}\n    `,\n  });\n}\n\nfunction LtiCredentialsCard({\n  lti_credentials,\n  csrfToken,\n}: {\n  lti_credentials: (Omit<LtiCredentials, 'deleted_at'> & {\n    created: string | null;\n    deleted: string | null;\n  })[];\n  csrfToken: string;\n}) {\n  return html`\n    <div class=\"card mb-4\">\n      <div class=\"card-header bg-primary text-white\">LTI credentials</div>\n      <div class=\"card-body\">\n        <p class=\"mb-0\">\n          Use these credentials with your LMS (Learning Management System) to connect into this\n          course instance. A single credential can be shared with multiple links.\n        </p>\n      </div>\n\n      <table class=\"table table-sm table-hover\" aria-label=\"LTI credentials\">\n        <thead>\n          <tr>\n            <th>Launch URL</th>\n            <th>Consumer key</th>\n            <th>Shared secret</th>\n            <th>Created</th>\n            <th>Deleted</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${lti_credentials\n            ? lti_credentials.map(\n                (tc) => html`\n                  <tr>\n                    <td>\n                      <code>${config.ltiRedirectUrl}</code>\n                      <button\n                        type=\"button\"\n                        class=\"btn btn-sm btn-ghost\"\n                        aria-label=\"Copy redirect URL to clipboard\"\n                        onClick=\"copyToClipboard($(this).prev());$(this).fadeOut({queue: true});$(this).fadeIn({queue:true});\"\n                      >\n                        <i class=\"far fa-copy\"></i>\n                      </button>\n                    </td>\n                    <td>\n                      <code>${tc.consumer_key}</code>\n                      <button\n                        type=\"button\"\n                        class=\"btn btn-sm btn-ghost\"\n                        aria-label=\"Copy consumer key to clipboard\"\n                        onClick=\"copyToClipboard($(this).prev());$(this).fadeOut({queue: true});$(this).fadeIn({queue:true});\"\n                      >\n                        <i class=\"far fa-copy\"></i>\n                      </button>\n                    </td>\n                    <td>\n                      <code>${tc.secret}</code>\n                      <button\n                        type=\"button\"\n                        class=\"btn btn-sm btn-ghost\"\n                        aria-label=\"Copy shared secret to clipboard\"\n                        onClick=\"copyToClipboard($(this).prev());$(this).fadeOut({queue: true});$(this).fadeIn({queue:true});\"\n                      >\n                        <i class=\"far fa-copy\"></i>\n                      </button>\n                    </td>\n                    <td>${tc.created}</td>\n                    <td>\n                      ${tc.deleted ||\n                      html`\n                        <button\n                          type=\"button\"\n                          class=\"btn btn-sm btn-danger\"\n                          data-bs-toggle=\"popover\"\n                          data-bs-container=\"body\"\n                          data-bs-html=\"true\"\n                          data-bs-placement=\"auto\"\n                          data-bs-title=\"Confirm delete\"\n                          data-bs-content=\"${escapeHtml(html`\n                            <form method=\"post\">\n                              <input type=\"hidden\" name=\"__action\" value=\"lti_del_cred\" />\n                              <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n                              <input type=\"hidden\" name=\"lti_link_id\" value=\"${tc.id}\" />\n                              <input type=\"submit\" class=\"btn btn-danger\" value=\"Delete\" />\n                            </form>\n                          `)}\"\n                        >\n                          Delete\n                        </button>\n                      `}\n                    </td>\n                  </tr>\n                `,\n              )\n            : html`\n                <tr>\n                  <td colspan=\"5\">\n                    <em>No LTI credentials have been created.</em>\n                  </td>\n                </tr>\n              `}\n        </tbody>\n      </table>\n\n      <div class=\"card-body\">\n        <form method=\"post\">\n          <input type=\"hidden\" name=\"__action\" value=\"lti_new_cred\" />\n          <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n          <input type=\"submit\" class=\"btn btn-success\" value=\"Create new LTI credential\" />\n        </form>\n      </div>\n    </div>\n  `;\n}\n\nfunction LtiLinkTargetsCard({\n  lti_links,\n  assessments,\n  csrfToken,\n}: {\n  lti_links: {\n    id: string;\n    resource_link_title: string | null;\n    resource_link_description: string | null;\n    assessment_id: string | null;\n    created: string | null;\n  }[];\n  assessments: {\n    assessment_id: string;\n    label: string;\n    title: string | null;\n    tid: string | null;\n  }[];\n  csrfToken: string;\n}) {\n  return html`\n    <div class=\"card mb-4\">\n      <div class=\"card-header bg-primary text-white\">LTI link targets</div>\n      <div class=\"card-body\">\n        <p>\n          LTI links connect an assessment from your LMS directly into a PrairieLearn assessment.\n          This is required for PrairieLearn to update scores in your LMS.\n        </p>\n        <p class=\"mb-0\">\n          To create a link, first create and follow the link in your LMS, then configure it here.\n        </p>\n      </div>\n\n      <table class=\"table table-sm table-hover\" aria-label=\"LTI link targets\">\n        <thead>\n          <tr>\n            <th>Link info</th>\n            <th>Assessment</th>\n            <th>Link first seen</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${lti_links\n            ? lti_links.map(\n                (link) => html`\n                  <tr>\n                    <td title=\"${link.resource_link_description}\">${link.resource_link_title}</td>\n                    <td>\n                      <form method=\"post\">\n                        <input type=\"hidden\" name=\"__action\" value=\"lti_link_target\" />\n                        <input type=\"hidden\" name=\"__csrf_token\" value=\"${csrfToken}\" />\n                        <input type=\"hidden\" name=\"lti_link_id\" value=\"${link.id}\" />\n                        <select\n                          class=\"form-select\"\n                          onChange=\"this.form.submit();\"\n                          name=\"newAssessment\"\n                        >\n                          <option value=\"\" ${!link.assessment_id ? 'selected' : ''}>-- None</option>\n                          ${assessments?.map(\n                            (a) => html`\n                              <option\n                                value=\"${a.assessment_id}\"\n                                ${link.assessment_id &&\n                                idsEqual(link.assessment_id, a.assessment_id)\n                                  ? 'selected'\n                                  : ''}\n                              >\n                                ${a.label}: ${a.title} (${a.tid})\n                              </option>\n                            `,\n                          )}\n                        </select>\n                      </form>\n                    </td>\n                    <td>${link.created}</td>\n                  </tr>\n                `,\n              )\n            : html`\n                <tr>\n                  <td colspan=\"3\">\n                    <em>No LTI links have been created.</em>\n                  </td>\n                </tr>\n              `}\n        </tbody>\n      </table>\n    </div>\n  `;\n}\n"]}