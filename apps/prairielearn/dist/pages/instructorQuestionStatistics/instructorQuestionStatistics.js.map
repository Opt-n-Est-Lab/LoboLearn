{"version":3,"file":"instructorQuestionStatistics.js","sourceRoot":"","sources":["../../../src/pages/instructorQuestionStatistics/instructorQuestionStatistics.ts"],"names":[],"mappings":"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","sourcesContent":["import { pipeline } from 'node:stream/promises';\n\nimport * as express from 'express';\nimport asyncHandler from 'express-async-handler';\n\nimport { stringifyStream } from '@prairielearn/csv';\nimport * as error from '@prairielearn/error';\nimport * as sqldb from '@prairielearn/postgres';\n\nimport { questionFilenamePrefix } from '../../lib/sanitize-name.js';\nimport { STAT_DESCRIPTIONS } from '../shared/assessmentStatDescriptions.js';\n\nimport {\n  AssessmentQuestionStatsRowSchema,\n  InstructorQuestionStatistics,\n} from './instructorQuestionStatistics.html.js';\n\nconst router = express.Router();\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\nfunction makeStatsCsvFilename(locals) {\n  const prefix = questionFilenamePrefix(locals.question, locals.course);\n  return prefix + 'stats.csv';\n}\n\nrouter.get(\n  '/',\n  asyncHandler(async (req, res) => {\n    // TODO: Support question statistics for shared questions. For now, forbid\n    // access to question statistics if question is shared from another course.\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    const rows = await sqldb.queryRows(\n      sql.assessment_question_stats,\n      {\n        question_id: res.locals.question.id,\n      },\n      AssessmentQuestionStatsRowSchema,\n    );\n\n    res.send(\n      InstructorQuestionStatistics({\n        questionStatsCsvFilename: makeStatsCsvFilename(res.locals),\n        rows,\n        resLocals: res.locals,\n      }),\n    );\n  }),\n);\n\nrouter.get(\n  '/:filename',\n  asyncHandler(async (req, res) => {\n    // TODO: Support question statistics for shared questions. For now, forbid\n    // access to question statistics if question is shared from another course.\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n\n    if (req.params.filename === makeStatsCsvFilename(res.locals)) {\n      const cursor = await sqldb.queryCursor(sql.assessment_question_stats, {\n        question_id: res.locals.question.id,\n      });\n\n      const stringifier = stringifyStream({\n        header: true,\n        columns: [\n          'Course',\n          'Instance',\n          'Assessment',\n          'Question number',\n          'QID',\n          'Question title',\n          'Question topic',\n          'Question tags',\n          ...Object.values(STAT_DESCRIPTIONS).map((d) => d.non_html_title),\n        ],\n        transform(record) {\n          return [\n            record.course_short_name,\n            record.course_instance_short_name,\n            record.assessment_label,\n            record.assessment_question_number,\n            record.qid,\n            record.question_title,\n            record.question_topic,\n            record.question_tags,\n            record.mean_question_score,\n            record.median_question_score,\n            record.question_score_variance,\n            record.discrimination,\n            record.some_submission_perc,\n            record.some_perfect_submission_perc,\n            record.some_nonzero_submission_perc,\n            record.average_first_submission_score,\n            record.first_submission_score_variance,\n            record.first_submission_score_hist,\n            record.average_last_submission_score,\n            record.last_submission_score_variance,\n            record.last_submission_score_hist,\n            record.average_max_submission_score,\n            record.max_submission_score_variance,\n            record.max_submission_score_hist,\n            record.average_average_submission_score,\n            record.average_submission_score_variance,\n            record.average_submission_score_hist,\n            record.submission_score_array_averages,\n            record.incremental_submission_score_array_averages,\n            record.incremental_submission_points_array_averages,\n            record.average_number_submissions,\n            record.number_submissions_variance,\n            record.number_submissions_hist,\n            record.quintile_question_scores,\n          ];\n        },\n      });\n\n      res.attachment(req.params.filename);\n      await pipeline(cursor.stream(100), stringifier, res);\n    } else {\n      throw new error.HttpStatusError(404, 'Unknown filename: ' + req.params.filename);\n    }\n  }),\n);\n\nexport default router;\n"]}