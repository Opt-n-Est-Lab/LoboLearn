{"version":3,"file":"access.test.js","sourceRoot":"","sources":["../../src/tests/access.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { assert } from 'chai';\nimport * as cheerio from 'cheerio';\nimport fetchCookie from 'fetch-cookie';\nimport fetch from 'node-fetch';\n\nimport * as sqldb from '@prairielearn/postgres';\n\nimport { config } from '../lib/config.js';\nimport { ensureEnrollment } from '../models/enrollment.js';\n\nimport * as helperServer from './helperServer.js';\n\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\nconst siteUrl = 'http://localhost:' + config.serverPort;\nconst baseUrl = siteUrl + '/pl';\nconst courseInstanceBaseUrl = baseUrl + '/course_instance/1';\nconst assessmentsUrl = courseInstanceBaseUrl + '/assessments';\nconst assessmentInstanceUrl = courseInstanceBaseUrl + '/assessment_instance/1';\n\ndescribe('Access control', function () {\n  this.timeout(20000);\n\n  before('set up testing server', helperServer.before());\n  after('shut down testing server', helperServer.after);\n\n  /*\n      There are three nested time periods:\n      reservation < assessment < course instance\n\n      Times are:\n\n      1750 before course instance\n      1800 start course instance\n      1850 before assessment\n      1900 start assessment\n      1950 before reservation\n      2000 start reservation\n\n      2200 end reservation\n      2250 after reservation\n      2300 end assessment\n      2350 after assessment\n      2400 end course instance\n      2450 after course_instance\n     */\n\n  function cookiesStudent() {\n    const cookies = new fetchCookie.toughCookie.CookieJar();\n    cookies.setCookie('pl_test_user=test_student', siteUrl);\n    return cookies;\n  }\n\n  function cookiesStudentExam() {\n    const cookies = cookiesStudent();\n    cookies.setCookie('pl_test_mode=Exam', siteUrl);\n    return cookies;\n  }\n\n  function cookiesStudentExamBeforeCourseInstance() {\n    const cookies = cookiesStudentExam();\n    cookies.setCookie('pl_test_date=1750-06-13T13:12:00Z', siteUrl);\n    return cookies;\n  }\n\n  function cookiesStudentExamBeforeAssessment() {\n    const cookies = cookiesStudentExam();\n    cookies.setCookie('pl_test_date=1850-06-13T13:12:00Z', siteUrl);\n    return cookies;\n  }\n\n  function cookiesStudentExamAfterAssessment() {\n    const cookies = cookiesStudentExam();\n    cookies.setCookie('pl_test_date=2350-06-13T13:12:00Z', siteUrl);\n    return cookies;\n  }\n\n  function cookiesStudentExamAfterCourseInstance() {\n    const cookies = cookiesStudentExam();\n    cookies.setCookie('pl_test_date=2450-06-13T13:12:00Z', siteUrl);\n    return cookies;\n  }\n\n  let user, page, $, elemList;\n  let assessment_id;\n  let __csrf_token;\n  let assessmentUrl, q1Url, questionData, variant, instance_question;\n\n  /**********************************************************************/\n\n  async function getPl(cookies, shouldContainQA101) {\n    const res = await fetchCookie(fetch, cookies)(siteUrl);\n    assert.equal(res.status, 200);\n    const page = await res.text();\n    $ = cheerio.load(page);\n    elemList = $('#content td a:contains(\"QA 101\")');\n    assert.lengthOf(elemList, shouldContainQA101 ? 1 : 0);\n  }\n\n  describe('1. GET /pl', function () {\n    it('as student should not contain QA 101', async () => {\n      await getPl(cookiesStudent(), false);\n    });\n  });\n\n  describe('2. the student user', function () {\n    it('should select from the DB', async () => {\n      const result = await sqldb.queryOneRowAsync(sql.select_student_user, []);\n      user = result.rows[0];\n    });\n  });\n\n  describe('3. Enroll student user into testCourse', function () {\n    it('should succeed', async () => {\n      await ensureEnrollment({ user_id: user.user_id, course_instance_id: '1' });\n    });\n  });\n\n  describe('4. GET /pl', function () {\n    it('as student should contain QA 101', async () => {\n      await getPl(cookiesStudent(), true);\n    });\n    it('as student in Exam mode before course instance time period should not contain QA 101', async () => {\n      await getPl(cookiesStudentExamBeforeCourseInstance(), false);\n    });\n    it('as student in Exam mode after course instance time period should not contain QA 101', async () => {\n      await getPl(cookiesStudentExamAfterCourseInstance(), false);\n    });\n  });\n\n  /**********************************************************************/\n\n  describe('5. database', function () {\n    it('should contain E1', async () => {\n      const result = await sqldb.queryOneRowAsync(sql.select_e1, []);\n      assessment_id = result.rows[0].id;\n    });\n  });\n\n  /**********************************************************************/\n\n  async function getAssessments(cookies, shouldContainE1) {\n    const res = await fetchCookie(fetch, cookies)(assessmentsUrl);\n    assert.equal(res.status, 200);\n    const page = await res.text();\n    $ = cheerio.load(page);\n    elemList = $('td a:contains(\"Exam for automatic test suite\")');\n    assert.lengthOf(elemList, shouldContainE1 ? 1 : 0);\n  }\n\n  describe('6. GET /pl/assessments', function () {\n    it('as student should not contain E1', async () => {\n      await getAssessments(cookiesStudent(), false);\n    });\n    it('as student in Exam mode before time period should not contain E1', async () => {\n      await getAssessments(cookiesStudentExamBeforeAssessment(), false);\n    });\n    it('as student in Exam mode after time period should not contain E1', async () => {\n      await getAssessments(cookiesStudentExamAfterAssessment(), false);\n    });\n    it('as student in Exam mode should contain E1', async () => {\n      await getAssessments(cookiesStudentExam(), true);\n    });\n    it('should have the correct link for E1', function () {\n      assert.nestedProperty(elemList[0], 'attribs.href');\n      assessmentUrl = siteUrl + elemList[0].attribs.href;\n      assert.equal(assessmentUrl, courseInstanceBaseUrl + '/assessment/' + assessment_id + '/');\n    });\n  });\n\n  /**********************************************************************/\n\n  async function getAssessment(cookies, expectedStatusCode) {\n    const res = await fetchCookie(fetch, cookies)(assessmentUrl);\n    assert.equal(res.status, expectedStatusCode);\n    page = await res.text();\n  }\n\n  describe('7. GET to assessment URL', function () {\n    it('as student should return 403', async () => {\n      await getAssessment(cookiesStudent(), 403);\n    });\n    it('as student in Exam mode before time period should return 403', async () => {\n      await getAssessment(cookiesStudentExamBeforeAssessment(), 403);\n    });\n    it('as student in Exam mode after time period should return 403', async () => {\n      await getAssessment(cookiesStudentExamAfterAssessment(), 403);\n    });\n    it('as student in Exam mode should load successfully', async () => {\n      await getAssessment(cookiesStudentExam(), 200);\n    });\n    it('should parse', function () {\n      $ = cheerio.load(page);\n    });\n    it('should have a CSRF token', function () {\n      elemList = $('form input[name=\"__csrf_token\"]');\n      assert.lengthOf(elemList, 1);\n      assert.nestedProperty(elemList[0], 'attribs.value');\n      __csrf_token = elemList[0].attribs.value;\n      assert.isString(__csrf_token);\n    });\n  });\n\n  /**********************************************************************/\n\n  async function postAssessment(cookies, includePassword, expectedStatusCode) {\n    const body = new URLSearchParams({\n      __action: 'new_instance',\n      __csrf_token,\n    });\n\n    if (includePassword) {\n      body.append('password', 'secret');\n    }\n\n    const res = await fetchCookie(fetch, cookies)(assessmentUrl, { method: 'POST', body });\n    assert.equal(res.status, expectedStatusCode);\n    page = await res.text();\n  }\n\n  describe('8. POST to assessment URL', function () {\n    it('as student should return 403', async () => {\n      await postAssessment(cookiesStudent(), true, 403);\n    });\n    it('as student in Exam mode before time period should return 403', async () => {\n      await postAssessment(cookiesStudentExamBeforeAssessment(), true, 403);\n    });\n    it('as student in Exam mode after time period should return 403', async () => {\n      await postAssessment(cookiesStudentExamAfterAssessment(), true, 403);\n    });\n    it('as student in Exam mode should load successfully', async () => {\n      await postAssessment(cookiesStudentExam(), true, 200);\n    });\n  });\n\n  /**********************************************************************/\n\n  async function getAssessmentInstance(cookies, expectedStatusCode) {\n    const res = await fetchCookie(fetch, cookies)(assessmentInstanceUrl);\n    assert.equal(res.status, expectedStatusCode);\n    page = await res.text();\n  }\n\n  describe('9. GET to assessment_instance URL', function () {\n    it('as student should return 403', async () => {\n      await getAssessmentInstance(cookiesStudent(), 403);\n    });\n    it('as student in Exam mode before time period should return 403', async () => {\n      await getAssessmentInstance(cookiesStudentExamBeforeAssessment(), 403);\n    });\n    it('as student in Exam mode after time period should return 403', async () => {\n      await getAssessmentInstance(cookiesStudentExamAfterAssessment(), 403);\n    });\n    it('as student in Exam mode should load successfully', async () => {\n      await getAssessmentInstance(cookiesStudentExam(), 200);\n    });\n    it('should parse', function () {\n      $ = cheerio.load(page);\n    });\n    it('should produce an addVectors instance_question in the DB', async () => {\n      const result = await sqldb.queryAsync(sql.select_instance_question_addVectors, []);\n      if (result.rowCount == null || result.rowCount === 0) {\n        throw new Error('did not find addVectors instance question in DB');\n      } else if (result.rowCount > 1) {\n        throw new Error('multiple rows found: ' + JSON.stringify(result.rows, null, '    '));\n      }\n      instance_question = result.rows[0];\n    });\n    it('should link to addVectors question', function () {\n      const urlTail = '/pl/course_instance/1/instance_question/' + instance_question.id + '/';\n      q1Url = siteUrl + urlTail;\n      elemList = $(`td a[href=\"${urlTail}\"]`);\n      assert.lengthOf(elemList, 1);\n    });\n  });\n\n  /**********************************************************************/\n\n  async function getInstanceQuestion(cookies, expectedStatusCode) {\n    const res = await fetchCookie(fetch, cookies)(q1Url);\n    assert.equal(res.status, expectedStatusCode);\n    page = await res.text();\n  }\n\n  describe('11. GET to instance_question URL', function () {\n    it('as student should return 403', async () => {\n      await getInstanceQuestion(cookiesStudent(), 403);\n    });\n    it('as student in Exam mode before time period should return 403', async () => {\n      await getInstanceQuestion(cookiesStudentExamBeforeAssessment(), 403);\n    });\n    it('as student in Exam mode after time period should return 403', async () => {\n      await getInstanceQuestion(cookiesStudentExamAfterAssessment(), 403);\n    });\n    it('as student in Exam mode should load successfully', async () => {\n      await getInstanceQuestion(cookiesStudentExam(), 200);\n    });\n    it('should parse', function () {\n      $ = cheerio.load(page);\n    });\n    it('should contain question-data', function () {\n      elemList = $('.question-data');\n      assert.lengthOf(elemList, 1);\n    });\n    it('question-data should contain base64 data', function () {\n      assert.nestedProperty(elemList[0], 'children.0.data');\n      assert.lengthOf(elemList[0].children, 1);\n      assert.property(elemList[0].children[0], 'data');\n    });\n    it('base64 data should parse to JSON', function () {\n      questionData = JSON.parse(\n        decodeURIComponent(Buffer.from(elemList[0].children[0].data, 'base64').toString()),\n      );\n    });\n    it('should have a variant_id in the questionData', function () {\n      assert.nestedProperty(questionData, 'variant.id');\n      variant = questionData.variant;\n    });\n    it('should have a CSRF token', function () {\n      elemList = $('.question-form input[name=\"__csrf_token\"]');\n      assert.lengthOf(elemList, 1);\n      assert.nestedProperty(elemList[0], 'attribs.value');\n      __csrf_token = elemList[0].attribs.value;\n      assert.isString(__csrf_token);\n    });\n  });\n\n  /**********************************************************************/\n\n  async function postInstanceQuestion(cookies, expectedStatusCode) {\n    const submittedAnswer = {\n      wx: 0,\n      wy: 0,\n    };\n    const res = await fetchCookie(fetch, cookies)(q1Url, {\n      method: 'POST',\n      body: new URLSearchParams({\n        __action: 'save',\n        __csrf_token,\n        postData: JSON.stringify({ variant, submittedAnswer }),\n      }),\n    });\n    assert.equal(res.status, expectedStatusCode);\n  }\n\n  describe('12. POST to instance_question URL', function () {\n    it('as student should return 403', async () => {\n      await postInstanceQuestion(cookiesStudent(), 403);\n    });\n    it('as student in Exam mode before time period should return 403', async () => {\n      await postInstanceQuestion(cookiesStudentExamBeforeAssessment(), 403);\n    });\n    it('as student in Exam mode after time period should return 403', async () => {\n      await postInstanceQuestion(cookiesStudentExamAfterAssessment(), 403);\n    });\n    it('as student in Exam mode should load successfully', async () => {\n      await postInstanceQuestion(cookiesStudentExam(), 200);\n    });\n  });\n});\n"]}